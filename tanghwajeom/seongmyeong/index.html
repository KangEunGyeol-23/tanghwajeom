<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ëª…í•™ ë¶„ì„ ë„êµ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            text-align: center;
            padding: 40px 20px;
        }
        
        .title {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            letter-spacing: 1px;
        }
        
        .input-section {
            padding: 40px;
            background: white;
            transition: all 0.5s ease;
        }
        
        .input-section.hidden {
            display: none;
        }
        
        .input-group {
            margin-bottom: 30px;
        }
        
        .input-group label {
            display: block;
            font-size: 1.1em;
            color: #444;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1em;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #007bff;
            background: white;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .analyze-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2em;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }
        
        .result {
            background: white;
            padding: 40px;
        }
        
        .result-title {
            text-align: center;
            font-size: 2.5em;
            color: #333;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ganzi-info {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            border-radius: 15px;
            color: #8b4513;
            font-weight: 700;
        }
        
        .char-analysis {
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .char-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            margin-bottom: 20px;
            table-layout: fixed;
        }
        
        .char-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            width: 14.28%;
            vertical-align: middle;
        }
        
        .ganzi-header {
            background: #6db4e8;
            color: white;
            height: 40px;
            font-size: 1.1em;
        }
        
        .derived-row {
            background: #e8eaf0;
            height: 35px;
        }
        
        .derived-cell {
            color: #d32f2f;
            font-size: 0.8em;
        }
        
        .cheoNeul-text {
            color: #1976d2;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .chung-text {
            color: #7b1fa2;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .sipseong-row {
            background: white;
            height: 60px;
            font-size: 1.2em;
        }
        
        .sipseong-number {
            color: #d32f2f;
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .char-cell {
            font-size: 3rem !important;
            background: #f8f9fa !important;
            font-weight: 900 !important;
            vertical-align: middle !important;
            text-align: center !important;
            height: 120px !important;
            line-height: 1 !important;
            padding: 0 !important;
            overflow: visible !important;
            position: relative !important;
            min-width: 80px !important;
        }
        
        .cheongan-row {
            background: #f0f0f0;
            height: 35px;
        }
        
        .jiji-row {
            background: #e8f4f8;
            height: 35px;
        }
        
        .buttons {
            text-align: center;
            margin-top: 30px;
        }
        
        .derived-toggle {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-right: 15px;
            transition: all 0.3s ease;
        }
        
        .derived-toggle:hover {
            transform: translateY(-2px);
        }
        
        .derived-toggle.active {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .new-analysis-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .new-analysis-btn:hover {
            transform: translateY(-2px);
        }
        
        .derived-highlight {
            background: #ffd700 !important;
        }
        
        .stroke-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
        
        /* ê¸°ëŠ¥ ì†Œê°œ ì„¹ì…˜ */
        .features-section {
            margin-top: 50px;
            text-align: center;
        }
        
        .features-section h3 {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 30px;
            font-weight: 600;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e9ecef;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .feature-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .feature-card h4 {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .feature-card p {
            font-size: 0.9em;
            color: #666;
            line-height: 1.5;
        }
        
        /* ì‚¬ìš©ë²• ì•ˆë‚´ */
        .guide-section {
            margin-top: 50px;
            text-align: center;
        }
        
        .guide-section h3 {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 30px;
            font-weight: 600;
        }
        
        .guide-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .step {
            display: flex;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }
        
        .step:hover {
            transform: translateY(-3px);
        }
        
        .step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .step p {
            font-size: 0.95em;
            color: #555;
            margin: 0;
            line-height: 1.4;
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header button {
                position: absolute !important;
                left: 10px !important;
                top: 15px !important;
                padding: 8px 12px !important;
                font-size: 14px !important;
            }
            
            .title {
                font-size: 2em !important;
                margin-top: 20px;
            }
            
            .input-section, .result {
                padding: 20px !important;
            }
            
            .char-table {
                font-size: 0.8em;
                table-layout: auto;
            }
            
            .char-cell {
                font-size: 2rem !important;
                height: 80px !important;
                min-width: 60px !important;
            }
            
            .sipseong-number {
                font-size: 1.4em !important;
            }
            
            .cheoNeul-text, .chung-text {
                font-size: 0.6em !important;
            }
            
            .ganzi-info {
                font-size: 1.4em !important;
                padding: 20px !important;
            }
            
            .buttons {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .derived-toggle, .new-analysis-btn {
                width: 100%;
                margin: 0 !important;
                padding: 12px !important;
                font-size: 1em !important;
            }
            
            .features-grid, .guide-steps {
                grid-template-columns: 1fr !important;
            }
            
            .char-table td {
                padding: 4px !important;
                font-size: 0.9em;
            }
            
            .stroke-info {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button onclick="goBack()" style="position: absolute; left: 20px; top: 20px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-size: 16px;">â¬…ï¸ ëŒì•„ê°€ê¸°</button>
            <h1 class="title">ğŸ”® ì„±ëª…í•™ ë¶„ì„</h1>
            <p class="subtitle">ì´ë¦„ê³¼ ìƒë…„ì›”ì¼ë¡œ ìš´ëª…ì„ ì½ë‹¤</p>
        </div>
        
        <div class="input-section" id="inputSection">
            <div class="input-group">
                <label for="nameInput">ì´ë¦„</label>
                <input type="text" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í™ê¸¸ë™)" maxlength="5">
            </div>
            
            <div class="input-group">
                <label for="yearInput">íƒœì–´ë‚œ ë…„ë„</label>
                <input type="number" id="yearInput" placeholder="ë…„ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1990)" min="1900" max="2025">
            </div>
            
            <button class="analyze-btn" onclick="analyzeName()">ğŸŒŸ ì„±ëª…í•™ ë¶„ì„í•˜ê¸°</button>
            
            <!-- ê¸°ëŠ¥ ì†Œê°œ ì„¹ì…˜ -->
            <div class="features-section">
                <h3>ğŸ” ë¶„ì„ ë‚´ìš©</h3>
                <div class="features-grid">
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ¯</div>
                        <h4>ì‹­ì„± ë¶„ì„</h4>
                        <p>ì´ë¦„ì˜ ììŒì„ ì˜¤í–‰ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì²œê°„ê³¼ì˜ ê´€ê³„ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">âš¡</div>
                        <h4>íŒŒìƒìˆ˜ ê³„ì‚°</h4>
                        <p>ì‹­ì„± ê°„ì˜ ìƒê·¹ ê´€ê³„ì—ì„œ ë‚˜íƒ€ë‚˜ëŠ” íŒŒìƒìˆ˜ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">ğŸŒŸ</div>
                        <h4>ê°„ì§€ ë¶„ì„</h4>
                        <p>íƒœì–´ë‚œ í•´ì˜ ê°„ì§€(ì²œê°„+ì§€ì§€)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìš´ëª…ì„ í•´ì„í•©ë‹ˆë‹¤</p>
                    </div>
                    <div class="feature-card">
                        <div class="feature-icon">ğŸ“Š</div>
                        <h4>ìŒì–‘ íŒë‹¨</h4>
                        <p>ì´ íšìˆ˜ë¡œ ìŒì–‘ì„ ê²°ì •í•˜ì—¬ ì •í™•í•œ ì˜¤í–‰ ë°°ì¹˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
            
            <!-- ì‚¬ìš©ë²• ì•ˆë‚´ -->
            <div class="guide-section">
                <h3>ğŸ“– ì‚¬ìš© ë°©ë²•</h3>
                <div class="guide-steps">
                    <div class="step">
                        <span class="step-number">1</span>
                        <p>í•œê¸€ ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”</p>
                    </div>
                    <div class="step">
                        <span class="step-number">2</span>
                        <p>íƒœì–´ë‚œ ë…„ë„ë¥¼ 4ìë¦¬ë¡œ ì…ë ¥í•˜ì„¸ìš”</p>
                    </div>
                    <div class="step">
                        <span class="step-number">3</span>
                        <p>ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                    <div class="step">
                        <span class="step-number">4</span>
                        <p>íŒŒìƒìˆ˜ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        // ììŒ íšìˆ˜
        const consonantStrokes = {
            'ã„±': 1, 'ã„´': 1, 'ã„·': 2, 'ã„¹': 3, 'ã…': 3, 'ã…‚': 4, 'ã……': 2,
            'ã…‡': 1, 'ã…ˆ': 3, 'ã…Š': 4, 'ã…‹': 2, 'ã…Œ': 3, 'ã…': 4, 'ã…': 3
        };
        
        // ëª¨ìŒ íšìˆ˜
        const vowelStrokes = {
            'ã…': 2, 'ã…‘': 3, 'ã…“': 2, 'ã…•': 3, 'ã…—': 2, 'ã…›': 3, 
            'ã…œ': 2, 'ã… ': 3, 'ã…¡': 1, 'ã…£': 1, 'ã…': 3, 'ã…’': 4, 
            'ã…”': 3, 'ã…–': 4, 'ã…˜': 4, 'ã…™': 5, 'ã…š': 4, 'ã…': 4, 
            'ã…': 5, 'ã…Ÿ': 4, 'ã…¢': 2
        };
        
        // ììŒ â†’ ì˜¤í–‰ ë¶„ë¥˜
        const consonantToElement = {
            'ã„±': 'æœ¨', 'ã…‹': 'æœ¨',
            'ã„´': 'ç«', 'ã„·': 'ç«', 'ã„¹': 'ç«', 'ã…Œ': 'ç«',
            'ã…‡': 'åœŸ', 'ã…': 'åœŸ',
            'ã……': 'é‡‘', 'ã…ˆ': 'é‡‘', 'ã…Š': 'é‡‘',
            'ã…': 'æ°´', 'ã…‚': 'æ°´', 'ã…': 'æ°´'
        };
        
        // ì‹­ì„± ì´ë¦„
        const sipseongNames = [
            'ì •ì¸', 'ë¹„ê²¬', 'ê²ì¬', 'ì‹ì‹ ', 'ìƒê´€', 'í¸ì¬', 'ì •ì¬', 'í¸ê´€', 'ì •ê´€', 'í¸ì¸'
        ];
        
        // ì²œì„ê·€ì¸í‘œ
        const cheonEulGuiIn = {
            'ç”²': ['ä¸‘', 'æœª'], 'ä¹™': ['ç”³', 'å­'], 'ä¸™': ['é…‰', 'äº¥'], 'ä¸': ['äº¥', 'é…‰'],
            'æˆŠ': ['ä¸‘', 'æœª'], 'å·±': ['å­', 'ç”³'], 'åºš': ['ä¸‘', 'æœª'], 'è¾›': ['å¯…', 'åˆ'],
            'å£¬': ['å¯', 'å·³'], 'ç™¸': ['å·³', 'å¯']
        };
        
        // ê·€ë¬¸ê´€ì‚´ ìŒ
        const guimunGwansal = [
            ['å­', 'é…‰'], ['ä¸‘', 'åˆ'], ['å¯…', 'æœª'], 
            ['å¯', 'ç”³'], ['è¾°', 'äº¥'], ['å·³', 'æˆŒ']
        ];
        
        // ê³µë§í‘œ (60ê°‘ì ê¸°ì¤€)
        const gongmang = {
            'ê°‘ì~ê³„ìœ ': ['æˆŒ', 'äº¥'],
            'ê°‘ìˆ ~ê³„ë¯¸': ['ç”³', 'é…‰'], 
            'ê°‘ì‹ ~ê³„ì‚¬': ['åˆ', 'æœª'],
            'ê°‘ì˜¤~ê³„ë¬˜': ['è¾°', 'å·³'],
            'ê°‘ì§„~ê³„ì¶•': ['å¯…', 'å¯'],
            'ê°‘ì¸~ê³„í•´': ['å­', 'ä¸‘']
        };
        
        // 60ê°‘ì ìˆœì„œ
        const sixtyGapja = [
            'ç”²å­','ä¹™ä¸‘','ä¸™å¯…','ä¸å¯','æˆŠè¾°','å·±å·³','åºšåˆ','è¾›æœª','å£¬ç”³','ç™¸é…‰', // 1-10
            'ç”²æˆŒ','ä¹™äº¥','ä¸™å­','ä¸ä¸‘','æˆŠå¯…','å·±å¯','åºšè¾°','è¾›å·³','å£¬åˆ','ç™¸æœª', // 11-20  
            'ç”²ç”³','ä¹™é…‰','ä¸™æˆŒ','ä¸äº¥','æˆŠå­','å·±ä¸‘','åºšå¯…','è¾›å¯','å£¬è¾°','ç™¸å·³', // 21-30
            'ç”²åˆ','ä¹™æœª','ä¸™ç”³','ä¸é…‰','æˆŠæˆŒ','å·±äº¥','åºšå­','è¾›ä¸‘','å£¬å¯…','ç™¸å¯', // 31-40
            'ç”²è¾°','ä¹™å·³','ä¸™åˆ','ä¸æœª','æˆŠç”³','å·±é…‰','åºšæˆŒ','è¾›äº¥','å£¬å­','ç™¸ä¸‘', // 41-50
            'ç”²å¯…','ä¹™å¯','ä¸™è¾°','ä¸å·³','æˆŠåˆ','å·±æœª','åºšç”³','è¾›é…‰','å£¬æˆŒ','ç™¸äº¥'  // 51-60
        ];
        
        // ì¶©(æ²–) ìŒ
        const chungPairs = [
            ['å¯…', 'ç”³'], ['å¯', 'é…‰'], ['è¾°', 'æˆŒ'], 
            ['å·³', 'äº¥'], ['åˆ', 'å­'], ['æœª', 'ä¸‘']
        ];
        
        // ì¶© í™•ì¸
        function checkChung(yearJiji, nameJiji) {
            return chungPairs.some(pair => 
                (pair[0] === yearJiji && pair[1] === nameJiji) ||
                (pair[1] === yearJiji && pair[0] === nameJiji)
            );
        }
        
        // ê·€ë¬¸ê´€ì‚´ í™•ì¸
        function checkGuimunGwansal(yearJiji, nameJiji) {
            return guimunGwansal.some(pair => 
                (pair[0] === yearJiji && pair[1] === nameJiji) ||
                (pair[1] === yearJiji && pair[0] === nameJiji)
            );
        }
        
        // ê³µë§ í™•ì¸
        function getGongmang(yearGanJi) {
            const index = sixtyGapja.indexOf(yearGanJi);
            if (index === -1) return [];
            
            const groupIndex = Math.floor(index / 10);
            const gongmangGroups = [
                ['æˆŒ', 'äº¥'], ['ç”³', 'é…‰'], ['åˆ', 'æœª'], 
                ['è¾°', 'å·³'], ['å¯…', 'å¯'], ['å­', 'ä¸‘']
            ];
            
            return gongmangGroups[groupIndex] || [];
        }
        
        // í† ì˜ ì§€ì§€ ë³€í™˜ (ìŒì–‘ê¶Œ ê³ ë ¤)
        function convertToJijiWithSeason(cheongan, yearJiji) {
            // ë…„ë„ ì§€ì§€ì˜ ìŒì–‘ê¶Œ íŒë‹¨
            const yangGwon = ['å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª']; // ë´„, ì—¬ë¦„
            const eumGwon = ['ç”³', 'é…‰', 'æˆŒ', 'äº¥', 'å­', 'ä¸‘']; // ê°€ì„, ê²¨ìš¸
            
            const isYangGwon = yangGwon.includes(yearJiji);
            
            const conversion = {
                'ç”²': 'å¯…', 'ä¹™': 'å¯', 'ä¸™': 'å·³', 'ä¸': 'åˆ', 
                'å£¬': 'äº¥', 'ç™¸': 'å­',
                'åºš': 'ç”³', 'è¾›': 'é…‰'
            };
            
            // í† ëŠ” íŠ¹ë³„ ì²˜ë¦¬
            if (cheongan === 'æˆŠ') {
                return isYangGwon ? 'è¾°' : 'æˆŒ';
            } else if (cheongan === 'å·±') {
                return isYangGwon ? 'æœª' : 'ä¸‘';
            }
            
            return conversion[cheongan] || '';
        }
        
        // í•œê¸€ ë¶„í•´
        function hangulDecompose(char) {
            const charCode = char.charCodeAt(0);
            if (charCode < 0xAC00 || charCode > 0xD7A3) return null;
            
            const index = charCode - 0xAC00;
            const initial = Math.floor(index / 588);
            const medial = Math.floor((index % 588) / 28);
            const final = index % 28;
            
            const initials = ['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            const medials = ['ã…','ã…','ã…‘','ã…’','ã…“','ã…”','ã…•','ã…–','ã…—','ã…˜','ã…™','ã…š','ã…›','ã…œ','ã…','ã…','ã…Ÿ','ã… ','ã…¡','ã…¢','ã…£'];
            const finals = ['','ã„±','ã„²','ã„±ã……','ã„´','ã„´ã…ˆ','ã„´ã…','ã„·','ã„¹','ã„¹ã„±','ã„¹ã…','ã„¹ã…‚','ã„¹ã……','ã„¹ã…Œ','ã„¹ã…','ã„¹ã…','ã…','ã…‚','ã…‚ã……','ã……','ã…†','ã…‡','ã…ˆ','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            
            return {
                initial: initials[initial],
                medial: medials[medial],
                final: final === 0 ? '' : finals[final]
            };
        }
        
        // ê°„ì§€ ê³„ì‚°
        function getGanJi(year) {
            const ganHanja = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
            const jiHanja = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
            const ganKorean = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„'];
            const jiKorean = ['ì', 'ì¶•', 'ì¸', 'ë¬˜', 'ì§„', 'ì‚¬', 'ì˜¤', 'ë¯¸', 'ì‹ ', 'ìœ ', 'ìˆ ', 'í•´'];
            
            const baseYear = 1984;
            const yearDiff = year - baseYear;
            
            let ganIndex = yearDiff % 10;
            let jiIndex = yearDiff % 12;
            
            if (ganIndex < 0) ganIndex += 10;
            if (jiIndex < 0) jiIndex += 12;
            
            return {
                ganHanja: ganHanja[ganIndex],
                jiHanja: jiHanja[jiIndex],
                fullKorean: ganKorean[ganIndex] + jiKorean[jiIndex] + 'ë…„'
            };
        }
        
        // ì‹­ì„± ê³„ì‚°
        function calculateSipseong(myElement, myYinYang, targetElement, targetYinYang) {
            const relations = {
                'æœ¨': { generates: 'ç«', destroys: 'åœŸ', generatedBy: 'æ°´', destroyedBy: 'é‡‘' },
                'ç«': { generates: 'åœŸ', destroys: 'é‡‘', generatedBy: 'æœ¨', destroyedBy: 'æ°´' },
                'åœŸ': { generates: 'é‡‘', destroys: 'æ°´', generatedBy: 'ç«', destroyedBy: 'æœ¨' },
                'é‡‘': { generates: 'æ°´', destroys: 'æœ¨', generatedBy: 'åœŸ', destroyedBy: 'ç«' },
                'æ°´': { generates: 'æœ¨', destroys: 'ç«', generatedBy: 'é‡‘', destroyedBy: 'åœŸ' }
            };
            
            if (!relations[targetElement] || !relations[myElement]) {
                return 0;
            }
            
            const sameYinYang = myYinYang === targetYinYang;
            
            if (myElement === targetElement) {
                // ë‚˜ì™€ ê°™ì€ ì˜¤í–‰
                return sameYinYang ? 1 : 2; // ë¹„ê²¬(1) : ê²ì¬(2)
            } else if (relations[targetElement].generates === myElement) {
                // ë‚˜ë¥¼ ìƒí•˜ëŠ” ì˜¤í–‰
                return sameYinYang ? 9 : 0; // í¸ì¸(9) : ì •ì¸(0)
            } else if (relations[myElement].generates === targetElement) {
                // ë‚´ê°€ ìƒí•˜ëŠ” ì˜¤í–‰
                return sameYinYang ? 3 : 4; // ì‹ì‹ (3) : ìƒê´€(4)
            } else if (relations[targetElement].destroys === myElement) {
                // ë‚˜ë¥¼ ê·¹í•˜ëŠ” ì˜¤í–‰
                return sameYinYang ? 7 : 8; // í¸ê´€(7) : ì •ê´€(8)
            } else if (relations[myElement].destroys === targetElement) {
                // ë‚´ê°€ ê·¹í•˜ëŠ” ì˜¤í–‰
                return sameYinYang ? 5 : 6; // í¸ì¬(5) : ì •ì¬(6)
            }
            
            return 0;
        }
        
        // í•œìì—ì„œ ì˜¤í–‰ ì¶”ì¶œ
        function getElementFromHanja(hanja) {
            const hanjaToElement = {
                'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 
                'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘',
                'å£¬': 'æ°´', 'ç™¸': 'æ°´',
                'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨', 
                'è¾°': 'åœŸ', 'å·³': 'ç«', 'åˆ': 'ç«', 'æœª': 'åœŸ',
                'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´'
            };
            return hanjaToElement[hanja] || 'åœŸ';
        }
        
        // í•œì ìŒì–‘ íŒë‹¨
        function getYinYangFromHanja(hanja) {
            const yangHanja = ['ç”²','ä¸™','æˆŠ','åºš','å£¬','å¯…','è¾°','åˆ','ç”³','æˆŒ'];
            return yangHanja.includes(hanja) ? 'yang' : 'eum';
        }
        
        function analyzeName() {
            const name = document.getElementById('nameInput').value.trim();
            const year = parseInt(document.getElementById('yearInput').value);
            
            if (!name || !year) {
                alert('ì´ë¦„ê³¼ íƒœì–´ë‚œ ë…„ë„ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            document.getElementById('inputSection').classList.add('hidden');
            
            const ganJi = getGanJi(year);
            const ganElement = getElementFromHanja(ganJi.ganHanja);
            const jiElement = getElementFromHanja(ganJi.jiHanja);
            const ganYinYang = getYinYangFromHanja(ganJi.ganHanja);
            const jiYinYang = getYinYangFromHanja(ganJi.jiHanja);
            
            let resultHTML = `
                <div class="result">
                    <div class="result-title">ğŸ”® ${name}ë‹˜ì˜ ì„±ëª…í•™ ë¶„ì„ ê²°ê³¼</div>
                    <div class="ganzi-info">
                        <strong>íƒœì–´ë‚œ í•´:</strong> ${year}ë…„ ${ganJi.fullKorean} (${ganJi.ganHanja}${ganJi.jiHanja})
                    </div>
            `;
            
            const charDataList = [];
            
            for (let i = 0; i < name.length; i++) {
                const char = name[i];
                const decomposed = hangulDecompose(char);
                
                if (!decomposed) continue;
                
                const {initial, medial, final} = decomposed;
                
                let totalStrokes = 0;
                totalStrokes += consonantStrokes[initial] || 0;
                totalStrokes += vowelStrokes[medial] || 0;
                if (final) {
                    totalStrokes += consonantStrokes[final] || 0;
                }
                
                const isYang = totalStrokes % 2 === 1;
                const yinYangType = isYang ? 'yang' : 'eum';
                
                const consonants = [initial];
                if (final && final !== '') {
                    consonants.push(final);
                }
                
                const charData = {
                    char: char,
                    totalStrokes: totalStrokes,
                    isYang: isYang,
                    consonants: consonants,
                    sipseongData: []
                };
                
                consonants.forEach(consonant => {
                    const element = consonantToElement[consonant];
                    if (element) {
                        const cheongan = isYang ? 
                            (element === 'æœ¨' ? 'ç”²' : element === 'ç«' ? 'ä¸™' : element === 'åœŸ' ? 'æˆŠ' : element === 'é‡‘' ? 'åºš' : 'å£¬') :
                            (element === 'æœ¨' ? 'ä¹™' : element === 'ç«' ? 'ä¸' : element === 'åœŸ' ? 'å·±' : element === 'é‡‘' ? 'è¾›' : 'ç™¸');
                        
                        const myElement = element;
                        const myYinYang = yinYangType;
                        
                        const ganSipseong = calculateSipseong(myElement, myYinYang, ganElement, ganYinYang);
                        const jiSipseong = calculateSipseong(myElement, myYinYang, jiElement, jiYinYang);
                        
                        charData.sipseongData.push({
                            consonant: consonant,
                            element: element,
                            cheongan: cheongan,
                            ganSipseong: ganSipseong,
                            jiSipseong: jiSipseong,
                            jiji: convertToJijiWithSeason(cheongan, ganJi.jiHanja)
                        });
                    }
                });
                
                charDataList.push(charData);
                
                let tableHTML = `
                    <div class="char-analysis">
                        <div class="stroke-info">${char}ì: ${totalStrokes}íš (${isYang ? 'ì–‘' : 'ìŒ'})</div>
                        <table class="char-table" data-char="${char}" data-char-index="${i}">
                            <tr>
                                <td colspan="7" class="ganzi-header">${ganJi.ganHanja} ${ganJi.jiHanja}</td>
                            </tr>
                            <tr class="derived-row">
                                <td class="derived-cell derived-left-cell">P</td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell derived-right-cell">P</td>
                            </tr>
                `;
                
                charData.sipseongData.forEach((sipseongInfo, index) => {
                    // ì²œì„ê·€ì¸ í™•ì¸
                    const yearGanGuiIn = cheonEulGuiIn[ganJi.ganHanja] || [];
                    const yearJiGuiIn = cheonEulGuiIn[ganJi.jiHanja] || [];
                    
                    const hasLeftCheonEul = yearGanGuiIn.includes(sipseongInfo.jiji);
                    const hasRightCheonEul = yearJiGuiIn.includes(sipseongInfo.jiji);
                    
                    // ê·€ë¬¸ê´€ì‚´ í™•ì¸
                    const hasLeftGuimun = checkGuimunGwansal(ganJi.jiHanja, sipseongInfo.jiji);
                    const hasRightGuimun = checkGuimunGwansal(ganJi.jiHanja, sipseongInfo.jiji);
                    
                    // ê³µë§ í™•ì¸
                    const yearGongmang = getGongmang(ganJi.ganHanja + ganJi.jiHanja);
                    const hasLeftGongmang = yearGongmang.includes(sipseongInfo.jiji);
                    const hasRightGongmang = yearGongmang.includes(sipseongInfo.jiji);
                    
                    // ì¶© í™•ì¸
                    const hasLeftChung = checkChung(ganJi.jiHanja, sipseongInfo.jiji);
                    const hasRightChung = checkChung(ganJi.jiHanja, sipseongInfo.jiji);
                    
                    // í‘œì‹œ í…ìŠ¤íŠ¸ ì¡°í•©
                    let leftSpecialText = '';
                    let rightSpecialText = '';
                    
                    // íŒŒë€ìƒ‰ í…ìŠ¤íŠ¸ë“¤
                    if (hasLeftCheonEul) leftSpecialText += 'ì²œì„';
                    if (hasLeftGuimun) {
                        if (leftSpecialText) leftSpecialText += '<br>';
                        leftSpecialText += 'ê·€ë¬¸';
                    }
                    if (hasLeftGongmang) {
                        if (leftSpecialText) leftSpecialText += '<br>';
                        leftSpecialText += 'ê³µë§';
                    }
                    
                    if (hasRightCheonEul) rightSpecialText += 'ì²œì„';
                    if (hasRightGuimun) {
                        if (rightSpecialText) rightSpecialText += '<br>';
                        rightSpecialText += 'ê·€ë¬¸';
                    }
                    if (hasRightGongmang) {
                        if (rightSpecialText) rightSpecialText += '<br>';
                        rightSpecialText += 'ê³µë§';
                    }
                    
                    // ë³´ë¼ìƒ‰ ì¶© í…ìŠ¤íŠ¸
                    let leftChungText = hasLeftChung ? 'ì¶©' : '';
                    let rightChungText = hasRightChung ? 'ì¶©' : '';
                    
                    if (index === 0) {
                        const rowSpan = charData.sipseongData.length;
                        tableHTML += `
                            <tr class="sipseong-row" data-left-sipseong="${sipseongInfo.ganSipseong}" data-right-sipseong="${sipseongInfo.jiSipseong}">
                                <td class="derived-left-cell"></td>
                                <td class="sipseong-number">${sipseongInfo.ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                <td>${sipseongNames[sipseongInfo.ganSipseong]}</td>
                                <td class="char-cell" rowspan="${rowSpan}">${char}</td>
                                <td>${sipseongNames[sipseongInfo.jiSipseong]}</td>
                                <td class="sipseong-number">${sipseongInfo.jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                <td class="derived-right-cell"></td>
                            </tr>
                        `;
                    } else {
                        tableHTML += `
                            <tr class="sipseong-row" data-left-sipseong="${sipseongInfo.ganSipseong}" data-right-sipseong="${sipseongInfo.jiSipseong}">
                                <td class="derived-left-cell"></td>
                                <td class="sipseong-number">${sipseongInfo.ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                <td>${sipseongNames[sipseongInfo.ganSipseong]}</td>
                                <td>${sipseongNames[sipseongInfo.jiSipseong]}</td>
                                <td class="sipseong-number">${sipseongInfo.jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                <td class="derived-right-cell"></td>
                            </tr>
                        `;
                    }
                });
                
                const cheonganList = charData.sipseongData.map(data => data.cheongan);
                tableHTML += `
                    <tr class="cheongan-row">
                        <td colspan="7">${cheonganList.join('')}</td>
                    </tr>
                </table>
                </div>
                `;
                
                resultHTML += tableHTML;
            }
            
            resultHTML += `
                <div class="buttons">
                    <button class="derived-toggle" onclick="toggleDerived()">ğŸ”¢ íŒŒìƒìˆ˜ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>
                    <button class="new-analysis-btn" onclick="newAnalysis()">ğŸ”„ ìƒˆë¡œìš´ ë¶„ì„í•˜ê¸°</button>
                </div>
                </div>
            `;
            
            document.getElementById('result').innerHTML = resultHTML;
            
            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            window.charDataList = charDataList;
            window.birthYear = year; // íƒœì–´ë‚œ ë…„ë„ ì €ì¥
        }
        
        // ì‹­ì„± ê·¸ë£¹ íŒë³„
        function getSipseongGroup(sipseong) {
            if ([1, 2].includes(sipseong)) return 'bijup'; // ë¹„ê²
            if ([3, 4].includes(sipseong)) return 'siksang'; // ì‹ìƒ
            if ([5, 6].includes(sipseong)) return 'jaeseong'; // ì¬ì„±
            if ([7, 8].includes(sipseong)) return 'gwanseong'; // ê´€ì„±
            if ([9, 0].includes(sipseong)) return 'inseong'; // ì¸ì„±
            return 'unknown';
        }
        
        // ìƒê·¹ ê´€ê³„ í™•ì¸
        function isGeukRelation(group1, group2) {
            const geukMap = {
                'bijup': 'jaeseong',    // ë¹„ê² â†’ ì¬ì„± ê·¹
                'jaeseong': 'inseong',  // ì¬ì„± â†’ ì¸ì„± ê·¹
                'inseong': 'siksang',   // ì¸ì„± â†’ ì‹ìƒ ê·¹
                'siksang': 'gwanseong', // ì‹ìƒ â†’ ê´€ì„± ê·¹
                'gwanseong': 'bijup'    // ê´€ì„± â†’ ë¹„ê² ê·¹
            };
            
            return geukMap[group1] === group2 || geukMap[group2] === group1;
        }
        
        // ê·¹ë‹¹í•˜ëŠ” ê·¸ë£¹ì´ ë„ë§ê°€ëŠ” ëŒ€ìƒ
        function getEscapeTarget(attackedGroup) {
            const escapeMap = {
                'bijup': [5, 6],      // ë¹„ê² ê·¹ë‹¹í•¨ â†’ ì¬ì„±ìœ¼ë¡œ ë„ë§
                'jaeseong': [9, 0],   // ì¬ì„± ê·¹ë‹¹í•¨ â†’ ì¸ì„±ìœ¼ë¡œ ë„ë§
                'inseong': [3, 4],    // ì¸ì„± ê·¹ë‹¹í•¨ â†’ ì‹ìƒìœ¼ë¡œ ë„ë§
                'siksang': [7, 8],    // ì‹ìƒ ê·¹ë‹¹í•¨ â†’ ê´€ì„±ìœ¼ë¡œ ë„ë§
                'gwanseong': [1, 2]   // ê´€ì„± ê·¹ë‹¹í•¨ â†’ ë¹„ê²ìœ¼ë¡œ ë„ë§
            };
            return escapeMap[attackedGroup] || [];
        }
        
        function toggleDerived() {
            const button = document.querySelector('.derived-toggle');
            const isActive = button.classList.contains('active');
            
            if (!isActive) {
                // íŒŒìƒìˆ˜ ë³´ì´ê¸°
                const charDataList = window.charDataList || [];
                
                // ê° ê¸€ìë³„ íŒŒìƒìˆ˜ ê³„ì‚°
                charDataList.forEach((charData, charIndex) => {
                    const table = document.querySelector(`[data-char-index="${charIndex}"]`);
                    if (!table) return;
                    
                    const leftSipseongs = charData.sipseongData.map(data => data.ganSipseong);
                    const rightSipseongs = charData.sipseongData.map(data => data.jiSipseong);
                    
                    // ì™¼ìª½ ì„¸ë¡œ íŒŒìƒìˆ˜ ê³„ì‚°
                    for (let i = 0; i < leftSipseongs.length - 1; i++) {
                        const current = leftSipseongs[i];
                        const next = leftSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            // ì–´ëŠ ìª½ì´ ê·¹ë‹¹í•˜ëŠ”ì§€ íŒë‹¨
                            const geukMap = {
                                'bijup': 'jaeseong',
                                'jaeseong': 'inseong',
                                'inseong': 'siksang',
                                'siksang': 'gwanseong',
                                'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup; // currentê°€ nextë¥¼ ê·¹í•¨
                            } else {
                                attackedGroup = currentGroup; // nextê°€ currentë¥¼ ê·¹í•¨
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            // í•´ë‹¹ í–‰ì˜ ì™¼ìª½ íŒŒìƒìˆ˜ ì…€ì— í‘œì‹œ
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const leftCell = rows[i].querySelector('.derived-left-cell');
                                if (leftCell) {
                                    leftCell.textContent = derivedText;
                                    leftCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                    
                    // ì˜¤ë¥¸ìª½ ì„¸ë¡œ íŒŒìƒìˆ˜ ê³„ì‚°
                    for (let i = 0; i < rightSipseongs.length - 1; i++) {
                        const current = rightSipseongs[i];
                        const next = rightSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong',
                                'jaeseong': 'inseong',
                                'inseong': 'siksang',
                                'siksang': 'gwanseong',
                                'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup;
                            } else {
                                attackedGroup = currentGroup;
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const rightCell = rows[i].querySelector('.derived-right-cell');
                                if (rightCell) {
                                    rightCell.textContent = derivedText;
                                    rightCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                });
                
                // ê¸€ì ê°„ íŒŒìƒìˆ˜ ê³„ì‚°
                for (let charIndex = 0; charIndex < charDataList.length - 1; charIndex++) {
                    const currentChar = charDataList[charIndex];
                    const nextChar = charDataList[charIndex + 1];
                    
                    if (currentChar.sipseongData.length === 0 || nextChar.sipseongData.length === 0) continue;
                    
                    // í˜„ì¬ ê¸€ìì˜ ë§ˆì§€ë§‰ ì‹­ì„±ë“¤ê³¼ ë‹¤ìŒ ê¸€ìì˜ ì²« ì‹­ì„±ë“¤ ë¹„êµ
                    const currentLastLeft = currentChar.sipseongData[currentChar.sipseongData.length - 1].ganSipseong;
                    const currentLastRight = currentChar.sipseongData[currentChar.sipseongData.length - 1].jiSipseong;
                    const nextFirstLeft = nextChar.sipseongData[0].ganSipseong;
                    const nextFirstRight = nextChar.sipseongData[0].jiSipseong;
                    
                    // ì™¼ìª½ ì—°ê²°
                    const leftCurrentGroup = getSipseongGroup(currentLastLeft);
                    const leftNextGroup = getSipseongGroup(nextFirstLeft);
                    
                    if (isGeukRelation(leftCurrentGroup, leftNextGroup)) {
                        const geukMap = {
                            'bijup': 'jaeseong',
                            'jaeseong': 'inseong',
                            'inseong': 'siksang',
                            'siksang': 'gwanseong',
                            'gwanseong': 'bijup'
                        };
                        
                        let attackedGroup;
                        if (geukMap[leftCurrentGroup] === leftNextGroup) {
                            attackedGroup = leftNextGroup;
                        } else {
                            attackedGroup = leftCurrentGroup;
                        }
                        
                        const escapeTarget = getEscapeTarget(attackedGroup);
                        const derivedText = escapeTarget.join(',');
                        
                        // í˜„ì¬ ê¸€ì ì˜¤ë¥¸ìª½ ë Pì— í‘œì‹œ
                        const currentTable = document.querySelector(`[data-char-index="${charIndex}"]`);
                        const currentRows = currentTable.querySelectorAll('.sipseong-row');
                        const currentLastRow = currentRows[currentRows.length - 1];
                        const currentRightCell = currentLastRow.querySelector('.derived-right-cell');
                        if (currentRightCell && currentRightCell.textContent === 'P') {
                            currentRightCell.textContent = derivedText;
                            currentRightCell.classList.add('derived-highlight');
                        }
                        
                        // ë‹¤ìŒ ê¸€ì ì™¼ìª½ ì²« Pì— í‘œì‹œ
                        const nextTable = document.querySelector(`[data-char-index="${charIndex + 1}"]`);
                        const nextRows = nextTable.querySelectorAll('.sipseong-row');
                        const nextFirstRow = nextRows[0];
                        const nextLeftCell = nextFirstRow.querySelector('.derived-left-cell');
                        if (nextLeftCell && nextLeftCell.textContent === 'P') {
                            nextLeftCell.textContent = derivedText;
                            nextLeftCell.classList.add('derived-highlight');
                        }
                    }
                    
                    // ì˜¤ë¥¸ìª½ ì—°ê²°
                    const rightCurrentGroup = getSipseongGroup(currentLastRight);
                    const rightNextGroup = getSipseongGroup(nextFirstRight);
                    
                    if (isGeukRelation(rightCurrentGroup, rightNextGroup)) {
                        const geukMap = {
                            'bijup': 'jaeseong',
                            'jaeseong': 'inseong',
                            'inseong': 'siksang',
                            'siksang': 'gwanseong',
                            'gwanseong': 'bijup'
                        };
                        
                        let attackedGroup;
                        if (geukMap[rightCurrentGroup] === rightNextGroup) {
                            attackedGroup = rightNextGroup;
                        } else {
                            attackedGroup = rightCurrentGroup;
                        }
                        
                        const escapeTarget = getEscapeTarget(attackedGroup);
                        const derivedText = escapeTarget.join(',');
                        
                        // í˜„ì¬ ê¸€ì ì˜¤ë¥¸ìª½ ë Pì— í‘œì‹œ (ì•„ì§ í‘œì‹œ ì•ˆëœ ê²½ìš°)
                        const currentTable = document.querySelector(`[data-char-index="${charIndex}"]`);
                        const currentRows = currentTable.querySelectorAll('.sipseong-row');
                        const currentLastRow = currentRows[currentRows.length - 1];
                        const currentRightCell = currentLastRow.querySelector('.derived-right-cell');
                        if (currentRightCell && currentRightCell.textContent === 'P') {
                            currentRightCell.textContent = derivedText;
                            currentRightCell.classList.add('derived-highlight');
                        }
                        
                        // ë‹¤ìŒ ê¸€ì ì™¼ìª½ ì²« Pì— í‘œì‹œ (ì•„ì§ í‘œì‹œ ì•ˆëœ ê²½ìš°)
                        const nextTable = document.querySelector(`[data-char-index="${charIndex + 1}"]`);
                        const nextRows = nextTable.querySelectorAll('.sipseong-row');
                        const nextFirstRow = nextRows[0];
                        const nextLeftCell = nextFirstRow.querySelector('.derived-left-cell');
                        if (nextLeftCell && nextLeftCell.textContent === 'P') {
                            nextLeftCell.textContent = derivedText;
                            nextLeftCell.classList.add('derived-highlight');
                        }
                    }
                }
                
                button.textContent = 'ğŸ“ íŒŒìƒìˆ˜ ìˆ¨ê¸°ê¸°';
                button.classList.add('active');
            } else {
                // íŒŒìƒìˆ˜ ìˆ¨ê¸°ê¸° - Pë¡œ ë³µì›
                const derivedCells = document.querySelectorAll('.derived-highlight');
                derivedCells.forEach(cell => {
                    cell.textContent = 'P';
                    cell.classList.remove('derived-highlight');
                });
                
                button.textContent = 'ğŸ”¢ íŒŒìƒìˆ˜ ë³´ê¸°/ìˆ¨ê¸°ê¸°';
                button.classList.remove('active');
            }
        }
        
        function newAnalysis() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('result').innerHTML = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('yearInput').value = '';
            document.getElementById('nameInput').focus();
            
            // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
            window.charDataList = [];
        }
        
        function showSaeun() {
            // ì„¸ìš´ ë…„ë„ ì…ë ¥ ë°›ê¸°
            const year = prompt("ì„¸ìš´ì„ ë³´ê³  ì‹¶ì€ ë…„ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 2025):");
            
            if (!year || isNaN(year)) {
                alert("ì˜¬ë°”ë¥¸ ë…„ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const saeunYear = parseInt(year);
            const saeunGanJi = getGanJi(saeunYear);
            
            // íƒœì–´ë‚œ ë…„ë„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì „ì—­ ë³€ìˆ˜ì—ì„œ)
            const birthYear = parseInt(document.getElementById('yearInput').value) || window.birthYear;
            const birthGanJi = getGanJi(birthYear);
            
            // ì„¸ìš´ ì‹­ì„± ê³„ì‚°
            const birthGanElement = getElementFromHanja(birthGanJi.ganHanja);
            const birthGanYinYang = getYinYangFromHanja(birthGanJi.ganHanja);
            const birthJiElement = getElementFromHanja(birthGanJi.jiHanja);
            const birthJiYinYang = getYinYangFromHanja(birthGanJi.jiHanja);
            
            const saeunGanElement = getElementFromHanja(saeunGanJi.ganHanja);
            const saeunGanYinYang = getYinYangFromHanja(saeunGanJi.ganHanja);
            const saeunJiElement = getElementFromHanja(saeunGanJi.jiHanja);
            const saeunJiYinYang = getYinYangFromHanja(saeunGanJi.jiHanja);
            
            // 4ê°œ ì‹­ì„± ê³„ì‚° (íƒœì–´ë‚œ ë…„ë„ â†’ ì„¸ìš´ ë…„ë„ ë³´ê¸°)
            const leftTop = calculateSipseong(birthGanElement, birthGanYinYang, saeunGanElement, saeunGanYinYang);    // ì²œê°„â†’ì²œê°„
            const rightTop = calculateSipseong(birthGanElement, birthGanYinYang, saeunJiElement, saeunJiYinYang);     // ì²œê°„â†’ì§€ì§€
            const leftBottom = calculateSipseong(birthJiElement, birthJiYinYang, saeunGanElement, saeunGanYinYang);   // ì§€ì§€â†’ì²œê°„
            const rightBottom = calculateSipseong(birthJiElement, birthJiYinYang, saeunJiElement, saeunJiYinYang);    // ì§€ì§€â†’ì§€ì§€
            
            // íŠ¹ìˆ˜ì‹ ì‚´ í™•ì¸ (ì„¸ìš´ ê¸°ì¤€)
            const saeunGanGuiIn = cheonEulGuiIn[birthGanJi.ganHanja] || [];
            const saeunJiGuiIn = cheonEulGuiIn[birthGanJi.jiHanja] || [];
            
            const hasLeftTopCheonEul = saeunGanGuiIn.includes(saeunGanJi.ganHanja);
            const hasRightTopCheonEul = saeunGanGuiIn.includes(saeunGanJi.jiHanja);
            const hasLeftBottomCheonEul = saeunJiGuiIn.includes(saeunGanJi.ganHanja);
            const hasRightBottomCheonEul = saeunJiGuiIn.includes(saeunGanJi.jiHanja);
            
            const hasLeftTopGuimun = checkGuimunGwansal(birthGanJi.jiHanja, saeunGanJi.ganHanja);
            const hasRightTopGuimun = checkGuimunGwansal(birthGanJi.jiHanja, saeunGanJi.jiHanja);
            const hasLeftBottomGuimun = checkGuimunGwansal(birthGanJi.jiHanja, saeunGanJi.ganHanja);
            const hasRightBottomGuimun = checkGuimunGwansal(birthGanJi.jiHanja, saeunGanJi.jiHanja);
            
            const yearGongmang = getGongmang(birthGanJi.ganHanja + birthGanJi.jiHanja);
            const hasLeftTopGongmang = yearGongmang.includes(saeunGanJi.ganHanja);
            const hasRightTopGongmang = yearGongmang.includes(saeunGanJi.jiHanja);
            const hasLeftBottomGongmang = yearGongmang.includes(saeunGanJi.ganHanja);
            const hasRightBottomGongmang = yearGongmang.includes(saeunGanJi.jiHanja);
            
            const hasLeftTopChung = checkChung(birthGanJi.jiHanja, saeunGanJi.ganHanja);
            const hasRightTopChung = checkChung(birthGanJi.jiHanja, saeunGanJi.jiHanja);
            const hasLeftBottomChung = checkChung(birthGanJi.jiHanja, saeunGanJi.ganHanja);
            const hasRightBottomChung = checkChung(birthGanJi.jiHanja, saeunGanJi.jiHanja);
            
            // íŠ¹ìˆ˜ í…ìŠ¤íŠ¸ ì¡°í•©
            function getSpecialText(cheonEul, guimun, gongmang, chung) {
                let blueText = '';
                if (cheonEul) blueText += 'ì²œì„';
                if (guimun) {
                    if (blueText) blueText += '<br>';
                    blueText += 'ê·€ë¬¸';
                }
                if (gongmang) {
                    if (blueText) blueText += '<br>';
                    blueText += 'ê³µë§';
                }
                
                let purpleText = chung ? 'ì¶©' : '';
                
                let result = '';
                if (blueText) result += '<br><span class="cheoNeul-text">' + blueText + '</span>';
                if (purpleText) result += '<br><span class="chung-text">' + purpleText + '</span>';
                
                return result;
            }
            
            // ì„¸ìš´ ê²°ê³¼ í‘œì‹œ
            const saeunHTML = `
                <div class="char-analysis" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px solid #2196f3;">
                    <h3 style="text-align: center; color: #1976d2; margin-bottom: 20px;">
                        ğŸ“… ${saeunYear}ë…„ ì„¸ìš´ (${birthYear}ë…„ìƒ ê¸°ì¤€)
                    </h3>
                    <table class="char-table">
                        <tr>
                            <td colspan="7" class="ganzi-header">${saeunGanJi.ganHanja} ${saeunGanJi.jiHanja}</td>
                        </tr>
                        <tr class="derived-row">
                            <td class="derived-cell derived-left-cell">P</td>
                            <td class="derived-cell"></td>
                            <td class="derived-cell"></td>
                            <td class="derived-cell"></td>
                            <td class="derived-cell"></td>
                            <td class="derived-cell"></td>
                            <td class="derived-cell derived-right-cell">P</td>
                        </tr>
                        <tr class="sipseong-row">
                            <td class="derived-left-cell"></td>
                            <td class="sipseong-number">${leftTop}${getSpecialText(hasLeftTopCheonEul, hasLeftTopGuimun, hasLeftTopGongmang, hasLeftTopChung)}</td>
                            <td>${sipseongNames[leftTop]}</td>
                            <td class="char-cell" rowspan="2">${saeunYear}ë…„</td>
                            <td>${sipseongNames[rightTop]}</td>
                            <td class="sipseong-number">${rightTop}${getSpecialText(hasRightTopCheonEul, hasRightTopGuimun, hasRightTopGongmang, hasRightTopChung)}</td>
                            <td class="derived-right-cell"></td>
                        </tr>
                        <tr class="sipseong-row">
                            <td class="derived-left-cell"></td>
                            <td class="sipseong-number">${leftBottom}${getSpecialText(hasLeftBottomCheonEul, hasLeftBottomGuimun, hasLeftBottomGongmang, hasLeftBottomChung)}</td>
                            <td>${sipseongNames[leftBottom]}</td>
                            <td>${sipseongNames[rightBottom]}</td>
                            <td class="sipseong-number">${rightBottom}${getSpecialText(hasRightBottomCheonEul, hasRightBottomGuimun, hasRightBottomGongmang, hasRightBottomChung)}</td>
                            <td class="derived-right-cell"></td>
                        </tr>
                        <tr class="cheongan-row">
                            <td colspan="7">${saeunGanJi.ganHanja}${saeunGanJi.jiHanja}</td>
                        </tr>
                    </table>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="toggleSaeunDerived(this)" class="derived-toggle" style="margin-right: 15px;">ğŸ”¢ ì„¸ìš´ íŒŒìƒìˆ˜ ë³´ê¸°</button>
                        <button onclick="closeSaeun()" class="new-analysis-btn" style="background: linear-gradient(135deg, #f44336, #d32f2f);">âŒ ì„¸ìš´ ë‹«ê¸°</button>
                    </div>
                </div>
            `;
            
            // ê²°ê³¼ ì˜ì—­ ëì— ì„¸ìš´ ì¶”ê°€
            const resultDiv = document.querySelector('.result');
            if (resultDiv) {
                resultDiv.insertAdjacentHTML('beforeend', saeunHTML);
                
                // ì„¸ìš´ ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
                document.querySelector('.char-analysis:last-child').scrollIntoView({ 
                    behavior: 'smooth' 
                });
            }
        }
        
        function toggleSaeunDerived(button) {
            // í˜„ì¬ëŠ” íŒŒìƒìˆ˜ê°€ ìë™ìœ¼ë¡œ í‘œì‹œë˜ë¯€ë¡œ ì´ í•¨ìˆ˜ëŠ” ë¹„í™œì„±í™”
            alert("ì„¸ìš´ íŒŒìƒìˆ˜ëŠ” ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤!");
        }
        
        function closeSaeun() {
            // ë§ˆì§€ë§‰ ì„¸ìš´ ê²°ê³¼ ì œê±°
            const saeunResults = document.querySelectorAll('.char-analysis');
            const lastSaeun = saeunResults[saeunResults.length - 1];
            
            // ì„¸ìš´ ê²°ê³¼ì¸ì§€ í™•ì¸ (ì œëª©ì— "ì„¸ìš´"ì´ í¬í•¨ëœ ê²½ìš°)
            if (lastSaeun && lastSaeun.innerHTML.includes('ì„¸ìš´')) {
                lastSaeun.remove();
            }
        }
        
        function goBack() {
            // ë¸Œë¼ìš°ì € ë’¤ë¡œ ê°€ê¸°
            window.history.back();
            
            // ë˜ëŠ” íŠ¹ì • í˜ì´ì§€ë¡œ ì´ë™í•˜ë ¤ë©´:
            // window.location.href = 'index.html'; // ì›°ì»´í˜ì´ì§€ íŒŒì¼ëª…ì— ë§ê²Œ ìˆ˜ì •
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('nameInput');
            const yearInput = document.getElementById('yearInput');
            
            if (nameInput) {
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        yearInput.focus();
                    }
                });
            }
            
            if (yearInput) {
                yearInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        analyzeName();
                    }
                });
            }
        });
    </script>
</body>
</html>
