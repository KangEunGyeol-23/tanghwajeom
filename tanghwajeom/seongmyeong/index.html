<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>성명학 분석 도구</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            text-align: center;
            padding: 40px 20px;
            position: relative;
        }
        
        .title {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            letter-spacing: 1px;
        }
        
        .input-section {
            padding: 40px;
            background: white;
            transition: all 0.5s ease;
        }
        
        .input-section.hidden {
            display: none;
        }
        
        .input-group {
            margin-bottom: 30px;
        }
        
        .input-group label {
            display: block;
            font-size: 1.1em;
            color: #444;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1em;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #007bff;
            background: white;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .analyze-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2em;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }
        
        .result {
            background: white;
            padding: 40px;
        }
        
        .result-title {
            text-align: center;
            font-size: 2.5em;
            color: #333;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ganzi-info {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            border-radius: 15px;
            color: #8b4513;
            font-weight: 700;
        }
        
        .char-analysis {
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .char-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            margin-bottom: 20px;
            table-layout: fixed;
        }
        
        .char-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            width: 14.28%;
            vertical-align: middle;
        }
        
        .saeun-table {
            width: 100% !important;
            table-layout: fixed !important;
        }
        
        .saeun-table td {
            width: 14.28% !important;
            min-width: 14.28% !important;
            max-width: 14.28% !important;
        }
        
        .ganzi-header {
            background: #6db4e8;
            color: white;
            height: 40px;
            font-size: 1.1em;
        }
        
        .derived-row {
            background: #e8eaf0;
            height: 35px;
        }
        
        .derived-cell {
            color: #d32f2f;
            font-size: 0.8em;
        }
        
        .sipseong-row {
            background: white;
            height: 60px;
            font-size: 1.2em;
        }
        
        .sipseong-number {
            color: #d32f2f;
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .char-cell {
            font-size: 3rem !important;
            background: #f8f9fa !important;
            font-weight: 900 !important;
            vertical-align: middle !important;
            text-align: center !important;
            height: 120px !important;
            line-height: 1 !important;
            padding: 0 !important;
            overflow: visible !important;
            position: relative !important;
            min-width: 80px !important;
        }
        
        .cheongan-row {
            background: #f0f0f0;
            height: 35px;
        }
        
        .buttons {
            text-align: center;
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        .derived-toggle {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .derived-toggle:hover {
            transform: translateY(-2px);
        }
        
        .derived-toggle.active {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .new-analysis-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .new-analysis-btn:hover {
            transform: translateY(-2px);
        }
        
        .saeun-btn {
            background: linear-gradient(135deg, #2196f3, #1976d2) !important;
        }
        
        .back-btn {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2) !important;
        }
        
        .derived-highlight {
            background: #ffd700 !important;
        }
        
        .stroke-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
        
        .cheoNeul-text {
            color: #1976d2;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .chung-text {
            color: #7b1fa2;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .back-header-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .back-header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .back-header-btn {
                left: 10px !important;
                top: 15px !important;
                padding: 8px 12px !important;
                font-size: 14px !important;
            }
            
            .title {
                font-size: 2em !important;
                margin-top: 20px;
            }
            
            .input-section, .result {
                padding: 20px !important;
            }
            
            .char-table {
                font-size: 0.8em;
                table-layout: auto;
            }
            
            .char-cell {
                font-size: 2rem !important;
                height: 80px !important;
                min-width: 60px !important;
            }
            
            .sipseong-number {
                font-size: 1.4em !important;
            }
            
            .cheoNeul-text, .chung-text {
                font-size: 0.6em !important;
            }
            
            .ganzi-info {
                font-size: 1.4em !important;
                padding: 20px !important;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .derived-toggle, .new-analysis-btn {
                width: 100%;
                margin: 0 !important;
                padding: 12px !important;
                font-size: 1em !important;
            }
            
            .char-table td {
                padding: 4px !important;
                font-size: 0.9em;
            }
            
            .stroke-info {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-header-btn" onclick="goBack()">← 뒤로</button>
            <h1 class="title">🔮 성명학 분석</h1>
            <p class="subtitle">이름과 생년월일로 운명을 읽다</p>
        </div>
        
        <div class="input-section" id="inputSection">
            <!-- 사용방법 -->
            <div style="margin-bottom: 40px;">
                <div style="background: white; border-radius: 15px; padding: 25px; text-align: center; color: #333; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; font-size: 1.3em; color: #333;">📋 사용 방법</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="background: #ff6b6b; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: 0 auto 10px; font-weight: bold;">1</div>
                            <p style="font-size: 0.9em; color: #333;">한글 이름을 정확히 입력하세요</p>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="background: #4ecdc4; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: 0 auto 10px; font-weight: bold;">2</div>
                            <p style="font-size: 0.9em; color: #333;">태어난 년도를 4자리로 입력하세요</p>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="background: #45b7d1; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: 0 auto 10px; font-weight: bold;">3</div>
                            <p style="font-size: 0.9em; color: #333;">분석 버튼을 클릭하여 결과를 확인하세요</p>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="background: #96ceb4; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: 0 auto 10px; font-weight: bold;">4</div>
                            <p style="font-size: 0.9em; color: #333;">파생수와 세운을 확인해보세요</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 이름 입력 -->
            <div class="input-group">
                <label for="nameInput">이름</label>
                <input type="text" id="nameInput" placeholder="이름을 입력하세요 (예: 홍길동)" maxlength="5">
            </div>
            
            <!-- 태어난 년도 입력 -->
            <div class="input-group">
                <label for="yearInput">태어난 년도</label>
                <input type="number" id="yearInput" placeholder="년도를 입력하세요 (예: 1990)" min="1900" max="2025">
            </div>
            
            <!-- 성명학 분석하기 버튼 -->
            <button class="analyze-btn" onclick="analyzeName()">🌟 성명학 분석하기</button>
            
            <!-- 분석 내용 -->
            <div style="margin-top: 50px;">
                <h3 style="text-align: center; color: #333; margin-bottom: 30px; font-size: 1.5em;">🔍 분석 내용</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f5f5f5; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <div style="font-size: 2em; margin-bottom: 10px;">🎯</div>
                        <h4 style="color: #333; margin-bottom: 8px;">십성 분석</h4>
                        <p style="color: #666; font-size: 0.9em;">이름과 생년월일의 오행 관계를<br>통한 십성 분석</p>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <div style="font-size: 2em; margin-bottom: 10px;">⚡</div>
                        <h4 style="color: #333; margin-bottom: 8px;">파생수 계산</h4>
                        <p style="color: #666; font-size: 0.9em;">십성 간의 상극 관계에서<br>나타나는 파생수 표시</p>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <div style="font-size: 2em; margin-bottom: 10px;">🌟</div>
                        <h4 style="color: #333; margin-bottom: 8px;">간지 분석</h4>
                        <p style="color: #666; font-size: 0.9em;">태어난 해의 간지와<br>천을귀인, 공망, 충 등 신살</p>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <div style="font-size: 2em; margin-bottom: 10px;">📅</div>
                        <h4 style="color: #333; margin-bottom: 8px;">음양 판단</h4>
                        <p style="color: #666; font-size: 0.9em;">이름 획수를 통한<br>음양 판단 및 오행 분류</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        // 전역 변수
        window.charDataList = [];
        window.birthYear = null;
        
        // 자음 획수
        const consonantStrokes = {
            'ㄱ': 1, 'ㄴ': 1, 'ㄷ': 2, 'ㄹ': 3, 'ㅁ': 3, 'ㅂ': 4, 'ㅅ': 2,
            'ㅇ': 1, 'ㅈ': 3, 'ㅊ': 4, 'ㅋ': 2, 'ㅌ': 3, 'ㅍ': 4, 'ㅎ': 3
        };
        
        // 모음 획수
        const vowelStrokes = {
            'ㅏ': 2, 'ㅑ': 3, 'ㅓ': 2, 'ㅕ': 3, 'ㅗ': 2, 'ㅛ': 3, 
            'ㅜ': 2, 'ㅠ': 3, 'ㅡ': 1, 'ㅣ': 1, 'ㅐ': 3, 'ㅒ': 4, 
            'ㅔ': 3, 'ㅖ': 4, 'ㅘ': 4, 'ㅙ': 5, 'ㅚ': 4, 'ㅝ': 4, 
            'ㅞ': 5, 'ㅟ': 4, 'ㅢ': 2
        };
        
        // 자음 → 오행 분류
        const consonantToElement = {
            'ㄱ': '木', 'ㅋ': '木',
            'ㄴ': '火', 'ㄷ': '火', 'ㄹ': '火', 'ㅌ': '火',
            'ㅇ': '土', 'ㅎ': '土',
            'ㅅ': '金', 'ㅈ': '金', 'ㅊ': '金',
            'ㅁ': '水', 'ㅂ': '水', 'ㅍ': '水'
        };
        
        // 십성 이름
        const sipseongNames = [
            '정인', '비견', '겁재', '식신', '상관', '편재', '정재', '편관', '정관', '편인'
        ];
        
        // 천을귀인표
        const cheonEulGuiIn = {
            '甲': ['丑', '未'], '乙': ['申', '子'], '丙': ['酉', '亥'], '丁': ['亥', '酉'],
            '戊': ['丑', '未'], '己': ['子', '申'], '庚': ['丑', '未'], '辛': ['寅', '午'],
            '壬': ['卯', '巳'], '癸': ['巳', '卯']
        };
        
        // 귀문관살 쌍
        const guimunGwansal = [
            ['子', '酉'], ['丑', '午'], ['寅', '未'], 
            ['卯', '申'], ['辰', '亥'], ['巳', '戌']
        ];
        
        // 충(沖) 쌍
        const chungPairs = [
            ['寅', '申'], ['卯', '酉'], ['辰', '戌'], 
            ['巳', '亥'], ['午', '子'], ['未', '丑']
        ];
        
        // 60갑자 순서
        const sixtyGapja = [
            '甲子','乙丑','丙寅','丁卯','戊辰','己巳','庚午','辛未','壬申','癸酉',
            '甲戌','乙亥','丙子','丁丑','戊寅','己卯','庚辰','辛巳','壬午','癸未',
            '甲申','乙酉','丙戌','丁亥','戊子','己丑','庚寅','辛卯','壬辰','癸巳',
            '甲午','乙未','丙申','丁酉','戊戌','己亥','庚子','辛丑','壬寅','癸卯',
            '甲辰','乙巳','丙午','丁未','戊申','己酉','庚戌','辛亥','壬子','癸丑',
            '甲寅','乙卯','丙辰','丁巳','戊午','己未','庚申','辛酉','壬戌','癸亥'
        ];
        
        // 한글 분해
        function hangulDecompose(char) {
            const charCode = char.charCodeAt(0);
            if (charCode < 0xAC00 || charCode > 0xD7A3) return null;
            
            const index = charCode - 0xAC00;
            const initial = Math.floor(index / 588);
            const medial = Math.floor((index % 588) / 28);
            const final = index % 28;
            
            const initials = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
            const medials = ['ㅏ','ㅐ','ㅑ','ㅒ','ㅓ','ㅔ','ㅕ','ㅖ','ㅗ','ㅘ','ㅙ','ㅚ','ㅛ','ㅜ','ㅝ','ㅞ','ㅟ','ㅠ','ㅡ','ㅢ','ㅣ'];
            const finals = ['','ㄱ','ㄲ','ㄱㅅ','ㄴ','ㄴㅈ','ㄴㅎ','ㄷ','ㄹ','ㄹㄱ','ㄹㅁ','ㄹㅂ','ㄹㅅ','ㄹㅌ','ㄹㅍ','ㄹㅎ','ㅁ','ㅂ','ㅂㅅ','ㅅ','ㅆ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
            
            return {
                initial: initials[initial],
                medial: medials[medial],
                final: final === 0 ? '' : finals[final]
            };
        }
        
        // 간지 계산
        function getGanJi(year) {
            const ganHanja = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
            const jiHanja = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
            const ganKorean = ['갑', '을', '병', '정', '무', '기', '경', '신', '임', '계'];
            const jiKorean = ['자', '축', '인', '묘', '진', '사', '오', '미', '신', '유', '술', '해'];
            
            const baseYear = 1984;
            const yearDiff = year - baseYear;
            
            let ganIndex = yearDiff % 10;
            let jiIndex = yearDiff % 12;
            
            if (ganIndex < 0) ganIndex += 10;
            if (jiIndex < 0) jiIndex += 12;
            
            return {
                ganHanja: ganHanja[ganIndex],
                jiHanja: jiHanja[jiIndex],
                fullKorean: ganKorean[ganIndex] + jiKorean[jiIndex] + '년'
            };
        }
        
        // 십성 계산
        function calculateSipseong(myElement, myYinYang, targetElement, targetYinYang) {
            const relations = {
                '木': { generates: '火', destroys: '土', generatedBy: '水', destroyedBy: '金' },
                '火': { generates: '土', destroys: '金', generatedBy: '木', destroyedBy: '水' },
                '土': { generates: '金', destroys: '水', generatedBy: '火', destroyedBy: '木' },
                '金': { generates: '水', destroys: '木', generatedBy: '土', destroyedBy: '火' },
                '水': { generates: '木', destroys: '火', generatedBy: '金', destroyedBy: '土' }
            };
            
            if (!relations[targetElement] || !relations[myElement]) {
                return 0;
            }
            
            const sameYinYang = myYinYang === targetYinYang;
            
            if (myElement === targetElement) {
                return sameYinYang ? 1 : 2;
            } else if (relations[targetElement].generates === myElement) {
                return sameYinYang ? 9 : 0;
            } else if (relations[myElement].generates === targetElement) {
                return sameYinYang ? 3 : 4;
            } else if (relations[targetElement].destroys === myElement) {
                return sameYinYang ? 7 : 8;
            } else if (relations[myElement].destroys === targetElement) {
                return sameYinYang ? 5 : 6;
            }
            
            return 0;
        }
        
        // 한자에서 오행 추출
        function getElementFromHanja(hanja) {
            const hanjaToElement = {
                '甲': '木', '乙': '木', '丙': '火', '丁': '火', 
                '戊': '土', '己': '土', '庚': '金', '辛': '金',
                '壬': '水', '癸': '水',
                '子': '水', '丑': '土', '寅': '木', '卯': '木', 
                '辰': '土', '巳': '火', '午': '火', '未': '土',
                '申': '金', '酉': '金', '戌': '土', '亥': '水'
            };
            return hanjaToElement[hanja] || '土';
        }
        
        // 한자 음양 판단
        function getYinYangFromHanja(hanja) {
            const yangHanja = ['甲','丙','戊','庚','壬','寅','辰','午','申','戌'];
            return yangHanja.includes(hanja) ? 'yang' : 'eum';
        }
        
        // 귀문관살 확인
        function checkGuimunGwansal(yearJiji, nameJiji) {
            return guimunGwansal.some(pair => 
                (pair[0] === yearJiji && pair[1] === nameJiji) ||
                (pair[1] === yearJiji && pair[0] === nameJiji)
            );
        }
        
        // 공망 확인
        function getGongmang(yearGanJi) {
            const index = sixtyGapja.indexOf(yearGanJi);
            if (index === -1) return [];
            
            const groupIndex = Math.floor(index / 10);
            const gongmangGroups = [
                ['戌', '亥'], ['申', '酉'], ['午', '未'], 
                ['辰', '巳'], ['寅', '卯'], ['子', '丑']
            ];
            
            return gongmangGroups[groupIndex] || [];
        }
        
        // 충 확인
        function checkChung(yearJiji, nameJiji) {
            return chungPairs.some(pair => 
                (pair[0] === yearJiji && pair[1] === nameJiji) ||
                (pair[1] === yearJiji && pair[0] === nameJiji)
            );
        }
        
        // 토의 지지 변환 (음양권 고려)
        function convertToJijiWithSeason(cheongan, yearJiji) {
            const yangGwon = ['寅', '卯', '辰', '巳', '午', '未'];
            const eumGwon = ['申', '酉', '戌', '亥', '子', '丑'];
            
            const isYangGwon = yangGwon.includes(yearJiji);
            
            const conversion = {
                '甲': '寅', '乙': '卯', '丙': '巳', '丁': '午', 
                '壬': '亥', '癸': '子', '庚': '申', '辛': '酉'
            };
            
            if (cheongan === '戊') {
                return isYangGwon ? '辰' : '戌';
            } else if (cheongan === '己') {
                return isYangGwon ? '未' : '丑';
            }
            
            return conversion[cheongan] || '';
        }
        
        // 십성 그룹 판별
        function getSipseongGroup(sipseong) {
            if ([1, 2].includes(sipseong)) return 'bijup';
            if ([3, 4].includes(sipseong)) return 'siksang';
            if ([5, 6].includes(sipseong)) return 'jaeseong';
            if ([7, 8].includes(sipseong)) return 'gwanseong';
            if ([9, 0].includes(sipseong)) return 'inseong';
            return 'unknown';
        }
        
        // 상극 관계 확인
        function isGeukRelation(group1, group2) {
            const geukMap = {
                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                'siksang': 'gwanseong', 'gwanseong': 'bijup'
            };
            
            return geukMap[group1] === group2 || geukMap[group2] === group1;
        }
        
        // 극당하는 그룹이 도망가는 대상
        function getEscapeTarget(attackedGroup) {
            const escapeMap = {
                'bijup': [5, 6], 'jaeseong': [9, 0], 'inseong': [3, 4],
                'siksang': [7, 8], 'gwanseong': [1, 2]
            };
            return escapeMap[attackedGroup] || [];
        }
        
        // 성명학 분석 함수
        function analyzeName() {
            const name = document.getElementById('nameInput').value.trim();
            const year = parseInt(document.getElementById('yearInput').value);
            
            if (!name || !year) {
                alert('이름과 태어난 년도를 모두 입력해주세요.');
                return;
            }
            
            document.getElementById('inputSection').classList.add('hidden');
            
            const ganJi = getGanJi(year);
            const ganElement = getElementFromHanja(ganJi.ganHanja);
            const jiElement = getElementFromHanja(ganJi.jiHanja);
            const ganYinYang = getYinYangFromHanja(ganJi.ganHanja);
            const jiYinYang = getYinYangFromHanja(ganJi.jiHanja);
            
            let resultHTML = `
                <div class="result">
                    <div class="result-title">🔮 ${name}님의 성명학 분석 결과</div>
                    <div class="ganzi-info">
                        <strong>태어난 해:</strong> ${year}년 ${ganJi.fullKorean} (${ganJi.ganHanja}${ganJi.jiHanja})
                    </div>
            `;
            
            const charDataList = [];
            
            for (let i = 0; i < name.length; i++) {
                const char = name[i];
                const decomposed = hangulDecompose(char);
                
                if (!decomposed) continue;
                
                const {initial, medial, final} = decomposed;
                
                let totalStrokes = 0;
                totalStrokes += consonantStrokes[initial] || 0;
                totalStrokes += vowelStrokes[medial] || 0;
                if (final) {
                    totalStrokes += consonantStrokes[final] || 0;
                }
                
                const isYang = totalStrokes % 2 === 1;
                const yinYangType = isYang ? 'yang' : 'eum';
                
                const consonants = [initial];
                if (final && final !== '') {
                    consonants.push(final);
                }
                
                const charData = {
                    char: char,
                    totalStrokes: totalStrokes,
                    isYang: isYang,
                    consonants: consonants,
                    sipseongData: []
                };
                
                consonants.forEach(consonant => {
                    const element = consonantToElement[consonant];
                    if (element) {
                        const cheongan = isYang ? 
                            (element === '木' ? '甲' : element === '火' ? '丙' : element === '土' ? '戊' : element === '金' ? '庚' : '壬') :
                            (element === '木' ? '乙' : element === '火' ? '丁' : element === '土' ? '己' : element === '金' ? '辛' : '癸');
                        
                        const myElement = element;
                        const myYinYang = yinYangType;
                        
                        const ganSipseong = calculateSipseong(myElement, myYinYang, ganElement, ganYinYang);
                        const jiSipseong = calculateSipseong(myElement, myYinYang, jiElement, jiYinYang);
                        
                        charData.sipseongData.push({
                            consonant: consonant,
                            element: element,
                            cheongan: cheongan,
                            ganSipseong: ganSipseong,
                            jiSipseong: jiSipseong,
                            jiji: convertToJijiWithSeason(cheongan, ganJi.jiHanja)
                        });
                    }
                });
                
                charDataList.push(charData);
                
                let tableHTML = `
                    <div class="char-analysis">
                        <div class="stroke-info">${char}자: ${totalStrokes}획 (${isYang ? '양' : '음'})</div>
                        <table class="char-table" data-char="${char}" data-char-index="${i}">
                            <tr>
                                <td colspan="7" class="ganzi-header">${ganJi.ganHanja} ${ganJi.jiHanja}</td>
                            </tr>
                            <tr class="derived-row">
                                <td class="derived-cell derived-left-cell">P</td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell derived-right-cell">P</td>
                            </tr>
                `;
                
                charData.sipseongData.forEach((sipseongInfo, index) => {
                    const yearGanGuiIn = cheonEulGuiIn[ganJi.ganHanja] || [];
                    const yearJiGuiIn = cheonEulGuiIn[ganJi.jiHanja] || [];
                    
                    const hasLeftCheonEul = yearGanGuiIn.includes(sipseongInfo.jiji);
                    const hasRightCheonEul = yearJiGuiIn.includes(sipseongInfo.jiji);
                    
                    const hasLeftGuimun = checkGuimunGwansal(ganJi.jiHanja, sipseongInfo.jiji);
                    const hasRightGuimun = checkGuimunGwansal(ganJi.jiHanja, sipseongInfo.jiji);
                    
                    const yearGongmang = getGongmang(ganJi.ganHanja + ganJi.jiHanja);
                    const hasLeftGongmang = yearGongmang.includes(sipseongInfo.jiji);
                    const hasRightGongmang = yearGongmang.includes(sipseongInfo.jiji);
                    
                    const hasLeftChung = checkChung(ganJi.jiHanja, sipseongInfo.jiji);
                    const hasRightChung = checkChung(ganJi.jiHanja, sipseongInfo.jiji);
                    
                    let leftSpecialText = '';
                    let rightSpecialText = '';
                    
                    if (hasLeftCheonEul) leftSpecialText += '천을';
                    if (hasLeftGuimun) {
                        if (leftSpecialText) leftSpecialText += '<br>';
                        leftSpecialText += '귀문';
                    }
                    if (hasLeftGongmang) {
                        if (leftSpecialText) leftSpecialText += '<br>';
                        leftSpecialText += '공망';
                    }
                    
                    if (hasRightCheonEul) rightSpecialText += '천을';
                    if (hasRightGuimun) {
                        if (rightSpecialText) rightSpecialText += '<br>';
                        rightSpecialText += '귀문';
                    }
                    if (hasRightGongmang) {
                        if (rightSpecialText) rightSpecialText += '<br>';
                        rightSpecialText += '공망';
                    }
                    
                    let leftChungText = hasLeftChung ? '충' : '';
                    let rightChungText = hasRightChung ? '충' : '';
                    
                    if (index === 0) {
                        const rowSpan = charData.sipseongData.length;
                        tableHTML += `
                            <tr class="sipseong-row" data-left-sipseong="${sipseongInfo.ganSipseong}" data-right-sipseong="${sipseongInfo.jiSipseong}">
                                <td class="derived-left-cell"></td>
                                <td class="sipseong-number">${sipseongInfo.ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                <td>${sipseongNames[sipseongInfo.ganSipseong]}</td>
                                <td class="char-cell" rowspan="${rowSpan}">${char}</td>
                                <td>${sipseongNames[sipseongInfo.jiSipseong]}</td>
                                <td class="sipseong-number">${sipseongInfo.jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                <td class="derived-right-cell"></td>
                            </tr>
                        `;
                    } else {
                        tableHTML += `
                            <tr class="sipseong-row" data-left-sipseong="${sipseongInfo.ganSipseong}" data-right-sipseong="${sipseongInfo.jiSipseong}">
                                <td class="derived-left-cell"></td>
                                <td class="sipseong-number">${sipseongInfo.ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                <td>${sipseongNames[sipseongInfo.ganSipseong]}</td>
                                <td>${sipseongNames[sipseongInfo.jiSipseong]}</td>
                                <td class="sipseong-number">${sipseongInfo.jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                <td class="derived-right-cell"></td>
                            </tr>
                        `;
                    }
                });
                
                const cheonganList = charData.sipseongData.map(data => data.cheongan);
                tableHTML += `
                    <tr class="cheongan-row">
                        <td colspan="7">${cheonganList.join('')}</td>
                    </tr>
                </table>
                </div>
                `;
                
                resultHTML += tableHTML;
            }
            
            resultHTML += `
                <div class="buttons">
                    <button class="derived-toggle" onclick="toggleDerived()">🔢 파생수 보기/숨기기</button>
                    <button class="new-analysis-btn" onclick="newAnalysis()">🔄 새로운 분석하기</button>
                    <button class="new-analysis-btn saeun-btn" onclick="testSaeun()">📅 세운 보기</button>
                </div>
                </div>
            `;
            
            document.getElementById('result').innerHTML = resultHTML;
            
            window.charDataList = charDataList;
            window.birthYear = year;
        }
        
        // 테스트용 세운 함수
        function testSaeun() {
            if (!window.birthYear) {
                alert('먼저 성명학 분석을 해주세요.');
                return;
            }
            
            const resultDiv = document.querySelector('.result');
            const inputHTML = `
                <div style="background: #fff3e0; padding: 30px; margin: 20px 0; border-radius: 15px; text-align: center; border: 2px solid #ff9800;">
                    <h3 style="color: #e65100; margin-bottom: 20px;">📅 세운 년도 입력</h3>
                    <input type="number" id="saeunYearInput" placeholder="예: 2025" style="padding: 15px; font-size: 1.2em; border: 2px solid #ddd; border-radius: 8px; width: 200px; text-align: center;" min="1900" max="2100">
                    <br><br>
                    <button onclick="calculateSaeun()" style="background: #2196f3; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1em; margin-right: 10px; cursor: pointer;">세운 계산하기</button>
                    <button onclick="closeSaeunInput()" style="background: #f44336; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1em; cursor: pointer;">취소</button>
                </div>
            `;
            
            resultDiv.insertAdjacentHTML('beforeend', inputHTML);
            document.getElementById('saeunYearInput').focus();
        }
        
        // 세운 계산 실행
        function calculateSaeun() {
            const yearInput = document.getElementById('saeunYearInput');
            const year = yearInput.value;
            
            if (!year || isNaN(year) || year < 1900 || year > 2100) {
                alert('1900~2100 사이의 올바른 년도를 입력해주세요!');
                return;
            }
            
            const saeunYear = parseInt(year);
            closeSaeunInput();
            showSaeunReal(saeunYear);
        }
        
        // 세운 입력창 닫기
        function closeSaeunInput() {
            const inputDiv = document.querySelector('.result > div:last-child');
            if (inputDiv && inputDiv.innerHTML.includes('세운 년도 입력')) {
                inputDiv.remove();
            }
        }
        
        // 실제 세운 계산 함수
        function showSaeunReal(saeunYear) {
            const saeunGanJi = getGanJi(saeunYear);
            const birthYear = window.birthYear;
            const birthGanJi = getGanJi(birthYear);
            
            createSaeunTable(saeunYear, saeunGanJi, birthYear, birthGanJi);
        }
        
        // 세운 표 만들기
        function createSaeunTable(saeunYear, saeunGanJi, birthYear, birthGanJi) {
            try {
                const charDataList = window.charDataList || [];
                if (charDataList.length === 0) {
                    alert('이름 분석 데이터가 없습니다. 먼저 성명학 분석을 해주세요.');
                    return;
                }
                
                const saeunGanElement = getElementFromHanja(saeunGanJi.ganHanja);
                const saeunGanYinYang = getYinYangFromHanja(saeunGanJi.ganHanja);
                const saeunJiElement = getElementFromHanja(saeunGanJi.jiHanja);
                const saeunJiYinYang = getYinYangFromHanja(saeunGanJi.jiHanja);
                
                let saeunHTML = `
                    <div class="char-analysis" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px solid #2196f3;">
                        <h3 style="text-align: center; color: #1976d2; margin-bottom: 20px; font-size: 3.5em; font-weight: 700;">
                            📅 ${saeunYear}년 세운 분석
                        </h3>
                `;
                
                charDataList.forEach((charData, charIndex) => {
                    let saeunTableHTML = `
                        <div style="margin-bottom: 30px;">
                            <div style="text-align: center; margin-bottom: 15px; font-weight: bold; color: #1976d2;">
                                ${charData.char}자 세운 (${charData.totalStrokes}획, ${charData.isYang ? '양' : '음'})
                            </div>
                            <table class="char-table" data-saeun-index="${charIndex}">
                                <tr>
                                    <td colspan="7" class="ganzi-header" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2) !important;">${saeunGanJi.ganHanja} ${saeunGanJi.jiHanja}</td>
                                </tr>
                                <tr class="derived-row">
                                    <td class="derived-cell derived-left-cell">P</td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell derived-right-cell">P</td>
                                </tr>
                    `;
                    
                    // 세운 십성들 계산
                    let saeunSipseongs = [];
                    charData.sipseongData.forEach((sipseongInfo, index) => {
                        const myElement = getElementFromHanja(sipseongInfo.cheongan);
                        const myYinYang = charData.isYang ? 'yang' : 'eum';
                        
                        const ganSipseong = calculateSipseong(myElement, myYinYang, saeunGanElement, saeunGanYinYang);
                        const jiSipseong = calculateSipseong(myElement, myYinYang, saeunJiElement, saeunJiYinYang);
                        
                        saeunSipseongs.push({ ganSipseong, jiSipseong, index });
                    });
                    
                    // 파생수 계산
                    let derivedData = [];
                    
                    // 왼쪽 세로 파생수
                    for (let i = 0; i < saeunSipseongs.length - 1; i++) {
                        const current = saeunSipseongs[i].ganSipseong;
                        const next = saeunSipseongs[i + 1].ganSipseong;
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            let attackedGroup = geukMap[currentGroup] === nextGroup ? nextGroup : currentGroup;
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            derivedData.push({ position: 'left', index: i, numbers: escapeTarget.join(',') });
                        }
                    }
                    
                    // 오른쪽 세로 파생수
                    for (let i = 0; i < saeunSipseongs.length - 1; i++) {
                        const current = saeunSipseongs[i].jiSipseong;
                        const next = saeunSipseongs[i + 1].jiSipseong;
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            let attackedGroup = geukMap[currentGroup] === nextGroup ? nextGroup : currentGroup;
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            derivedData.push({ position: 'right', index: i, numbers: escapeTarget.join(',') });
                        }
                    }
                    
                    charData.sipseongData.forEach((sipseongInfo, index) => {
                        const myElement = getElementFromHanja(sipseongInfo.cheongan);
                        const myYinYang = charData.isYang ? 'yang' : 'eum';
                        
                        const ganSipseong = calculateSipseong(myElement, myYinYang, saeunGanElement, saeunGanYinYang);
                        const jiSipseong = calculateSipseong(myElement, myYinYang, saeunJiElement, saeunJiYinYang);
                        
                        // 세운에서의 신살 계산
                        const saeunGanGuiIn = cheonEulGuiIn[saeunGanJi.ganHanja] || [];
                        const saeunJiGuiIn = cheonEulGuiIn[saeunGanJi.jiHanja] || [];
                        
                        const hasLeftCheonEul = saeunGanGuiIn.includes(sipseongInfo.jiji);
                        const hasRightCheonEul = saeunJiGuiIn.includes(sipseongInfo.jiji);
                        
                        const hasLeftGuimun = checkGuimunGwansal(saeunGanJi.jiHanja, sipseongInfo.jiji);
                        const hasRightGuimun = checkGuimunGwansal(saeunGanJi.jiHanja, sipseongInfo.jiji);
                        
                        const saeunGongmang = getGongmang(saeunGanJi.ganHanja + saeunGanJi.jiHanja);
                        const hasLeftGongmang = saeunGongmang.includes(sipseongInfo.jiji);
                        const hasRightGongmang = saeunGongmang.includes(sipseongInfo.jiji);
                        
                        const hasLeftChung = checkChung(saeunGanJi.jiHanja, sipseongInfo.jiji);
                        const hasRightChung = checkChung(saeunGanJi.jiHanja, sipseongInfo.jiji);
                        
                        let leftSpecialText = '';
                        let rightSpecialText = '';
                        
                        if (hasLeftCheonEul) leftSpecialText += '천을';
                        if (hasLeftGuimun) {
                            if (leftSpecialText) leftSpecialText += '<br>';
                            leftSpecialText += '귀문';
                        }
                        if (hasLeftGongmang) {
                            if (leftSpecialText) leftSpecialText += '<br>';
                            leftSpecialText += '공망';
                        }
                        
                        if (hasRightCheonEul) rightSpecialText += '천을';
                        if (hasRightGuimun) {
                            if (rightSpecialText) rightSpecialText += '<br>';
                            rightSpecialText += '귀문';
                        }
                        if (hasRightGongmang) {
                            if (rightSpecialText) rightSpecialText += '<br>';
                            rightSpecialText += '공망';
                        }
                        
                        let leftChungText = hasLeftChung ? '충' : '';
                        let rightChungText = hasRightChung ? '충' : '';
                        
                        // 이 행의 파생수 찾기
                        const leftDerived = derivedData.find(d => d.position === 'left' && d.index === index);
                        const rightDerived = derivedData.find(d => d.position === 'right' && d.index === index);
                        
                        if (index === 0) {
                            const rowSpan = charData.sipseongData.length;
                            saeunTableHTML += `
                                <tr class="sipseong-row">
                                    <td class="derived-left-cell"></td>
                                    <td class="sipseong-number">${ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                    <td>${sipseongNames[ganSipseong]}</td>
                                    <td class="char-cell" rowspan="${rowSpan}">${charData.char}</td>
                                    <td>${sipseongNames[jiSipseong]}</td>
                                    <td class="sipseong-number">${jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                    <td class="derived-right-cell"></td>
                                </tr>
                            `;
                        } else {
                            saeunTableHTML += `
                                <tr class="sipseong-row">
                                    <td class="derived-left-cell"></td>
                                    <td class="sipseong-number">${ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                    <td>${sipseongNames[ganSipseong]}</td>
                                    <td>${sipseongNames[jiSipseong]}</td>
                                    <td class="sipseong-number">${jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                    <td class="derived-right-cell"></td>
                                </tr>
                            `;
                        }
                    });
                    
                    const cheonganList = charData.sipseongData.map(data => data.cheongan);
                    saeunTableHTML += `
                        <tr class="cheongan-row">
                            <td colspan="7" style="background: #f0f0f0; height: 35px; text-align: center; font-weight: bold;">${cheonganList.join('')}</td>
                        </tr>
                    </table>
                    </div>
                    `;
                    
                    saeunHTML += saeunTableHTML;
                });
                
                saeunHTML += `
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="toggleSaeunDerived()" class="derived-toggle" style="margin-right: 15px;">🔢 세운 파생수 보기</button>
                            <button onclick="closeSaeun()" class="new-analysis-btn" style="background: linear-gradient(135deg, #f44336, #d32f2f);">❌ 세운 닫기</button>
                        </div>
                    </div>
                `;
                
                const resultDiv = document.querySelector('.result');
                if (resultDiv) {
                    resultDiv.insertAdjacentHTML('beforeend', saeunHTML);
                    document.querySelector('.char-analysis:last-child').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                }
                
            } catch (error) {
                console.error('세운 계산 오류:', error);
                alert('세운 계산 중 오류가 발생했습니다: ' + error.message);
            }
        }
        
        // 세운 파생수 토글 함수
        function toggleSaeunDerived() {
            const button = document.querySelector('.char-analysis:last-child .derived-toggle');
            const saeunContainer = document.querySelector('.char-analysis:last-child');
            const isActive = button.classList.contains('active');
            
            if (!isActive) {
                // 세운 파생수 보이기 - 원본 성명학 분석과 동일한 방식으로 처리
                const charDataList = window.charDataList || [];
                
                charDataList.forEach((charData, charIndex) => {
                    const table = saeunContainer.querySelector(`[data-saeun-index="${charIndex}"]`);
                    if (!table) return;
                    
                    // 세운 십성들을 다시 계산해서 파생수 적용
                    const saeunGanJi = getGanJi(parseInt(button.closest('.char-analysis').querySelector('h3').textContent.match(/\d{4}/)[0]));
                    const saeunGanElement = getElementFromHanja(saeunGanJi.ganHanja);
                    const saeunGanYinYang = getYinYangFromHanja(saeunGanJi.ganHanja);
                    const saeunJiElement = getElementFromHanja(saeunGanJi.jiHanja);
                    const saeunJiYinYang = getYinYangFromHanja(saeunGanJi.jiHanja);
                    
                    const leftSipseongs = [];
                    const rightSipseongs = [];
                    
                    charData.sipseongData.forEach((sipseongInfo) => {
                        const myElement = getElementFromHanja(sipseongInfo.cheongan);
                        const myYinYang = charData.isYang ? 'yang' : 'eum';
                        
                        const ganSipseong = calculateSipseong(myElement, myYinYang, saeunGanElement, saeunGanYinYang);
                        const jiSipseong = calculateSipseong(myElement, myYinYang, saeunJiElement, saeunJiYinYang);
                        
                        leftSipseongs.push(ganSipseong);
                        rightSipseongs.push(jiSipseong);
                    });
                    
                    for (let i = 0; i < leftSipseongs.length - 1; i++) {
                        const current = leftSipseongs[i];
                        const next = leftSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup;
                            } else {
                                attackedGroup = currentGroup;
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const leftCell = rows[i].querySelector('.derived-left-cell');
                                if (leftCell) {
                                    leftCell.textContent = derivedText;
                                    leftCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                    
                    for (let i = 0; i < rightSipseongs.length - 1; i++) {
                        const current = rightSipseongs[i];
                        const next = rightSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup;
                            } else {
                                attackedGroup = currentGroup;
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const rightCell = rows[i].querySelector('.derived-right-cell');
                                if (rightCell) {
                                    rightCell.textContent = derivedText;
                                    rightCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                });
                
                button.textContent = '📁 세운 파생수 숨기기';
                button.classList.add('active');
            } else {
                // 세운 파생수 숨기기
                const derivedCells = saeunContainer.querySelectorAll('.derived-highlight');
                derivedCells.forEach(cell => {
                    cell.textContent = 'P';
                    cell.classList.remove('derived-highlight');
                });
                
                button.textContent = '🔢 세운 파생수 보기';
                button.classList.remove('active');
            }
        }
        
        // 세운 닫기 함수
        function closeSaeun() {
            const saeunResults = document.querySelectorAll('.char-analysis');
            const lastSaeun = saeunResults[saeunResults.length - 1];
            
            if (lastSaeun && lastSaeun.innerHTML.includes('세운')) {
                lastSaeun.remove();
            }
        }
        
        // 파생수 토글 함수
        function toggleDerived() {
            const button = document.querySelector('.derived-toggle');
            const isActive = button.classList.contains('active');
            
            if (!isActive) {
                const charDataList = window.charDataList || [];
                
                charDataList.forEach((charData, charIndex) => {
                    const table = document.querySelector(`[data-char-index="${charIndex}"]`);
                    if (!table) return;
                    
                    const leftSipseongs = charData.sipseongData.map(data => data.ganSipseong);
                    const rightSipseongs = charData.sipseongData.map(data => data.jiSipseong);
                    
                    for (let i = 0; i < leftSipseongs.length - 1; i++) {
                        const current = leftSipseongs[i];
                        const next = leftSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup;
                            } else {
                                attackedGroup = currentGroup;
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const leftCell = rows[i].querySelector('.derived-left-cell');
                                if (leftCell) {
                                    leftCell.textContent = derivedText;
                                    leftCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                    
                    for (let i = 0; i < rightSipseongs.length - 1; i++) {
                        const current = rightSipseongs[i];
                        const next = rightSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup;
                            } else {
                                attackedGroup = currentGroup;
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const rightCell = rows[i].querySelector('.derived-right-cell');
                                if (rightCell) {
                                    rightCell.textContent = derivedText;
                                    rightCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                });
                
                button.textContent = '📁 파생수 숨기기';
                button.classList.add('active');
            } else {
                const derivedCells = document.querySelectorAll('.derived-highlight');
                derivedCells.forEach(cell => {
                    cell.textContent = 'P';
                    cell.classList.remove('derived-highlight');
                });
                
                button.textContent = '🔢 파생수 보기/숨기기';
                button.classList.remove('active');
            }
        }
        
        // 새로운 분석 함수
        function newAnalysis() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('result').innerHTML = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('yearInput').value = '';
            document.getElementById('nameInput').focus();
            
            window.charDataList = [];
            window.birthYear = null;
        }
        
        // 뒤로 가기 함수
        window.goBack = function() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // 만약 히스토리가 없다면 상위 페이지로 이동 (필요에 따라 수정)
                window.location.href = '../index.html';
            }
        }
        
        // 이벤트 리스너
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('nameInput');
            const yearInput = document.getElementById('yearInput');
            
            if (nameInput) {
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        yearInput.focus();
                    }
                });
            }
            
            if (yearInput) {
                yearInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        analyzeName();
                    }
                });
            }
        });
    </script>
</body>
</html>
