<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„±ëª…í•™ ë¶„ì„ ë„êµ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            text-align: center;
            padding: 40px 20px;
            position: relative;
        }
        
        .title {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
            letter-spacing: 1px;
        }
        
        .input-section {
            padding: 40px;
            background: white;
            transition: all 0.5s ease;
        }
        
        .input-section.hidden {
            display: none;
        }
        
        .input-group {
            margin-bottom: 30px;
        }
        
        .input-group label {
            display: block;
            font-size: 1.1em;
            color: #444;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .input-group input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1em;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            color: #333;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #007bff;
            background: white;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .analyze-btn {
            width: 100%;
            padding: 18px;
            font-size: 1.2em;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
        }
        
        .result {
            background: white;
            padding: 40px;
        }
        
        .result-title {
            text-align: center;
            font-size: 2.5em;
            color: #333;
            font-weight: 700;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ganzi-info {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            border-radius: 15px;
            color: #8b4513;
            font-weight: 700;
        }
        
        .char-analysis {
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .char-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: white;
            margin-bottom: 20px;
            table-layout: fixed;
        }
        
        .char-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
            width: 14.28%;
            vertical-align: middle;
        }
        
        .saeun-table {
            width: 100% !important;
            table-layout: fixed !important;
        }
        
        .saeun-table td {
            width: 14.28% !important;
            min-width: 14.28% !important;
            max-width: 14.28% !important;
        }
        
        .ganzi-header {
            background: #6db4e8;
            color: white;
            height: 40px;
            font-size: 1.1em;
        }
        
        .derived-row {
            background: #e8eaf0;
            height: 35px;
        }
        
        .derived-cell {
            color: #d32f2f;
            font-size: 0.8em;
        }
        
        .sipseong-row {
            background: white;
            height: 60px;
            font-size: 1.2em;
        }
        
        .sipseong-number {
            color: #d32f2f;
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .char-cell {
            font-size: 3rem !important;
            background: #f8f9fa !important;
            font-weight: 900 !important;
            vertical-align: middle !important;
            text-align: center !important;
            height: 120px !important;
            line-height: 1 !important;
            padding: 0 !important;
            overflow: visible !important;
            position: relative !important;
            min-width: 80px !important;
        }
        
        .cheongan-row {
            background: #f0f0f0;
            height: 35px;
        }
        
        .buttons {
            text-align: center;
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }
        
        .derived-toggle {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .derived-toggle:hover {
            transform: translateY(-2px);
        }
        
        .derived-toggle.active {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .new-analysis-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .new-analysis-btn:hover {
            transform: translateY(-2px);
        }
        
        .saeun-btn {
            background: linear-gradient(135deg, #2196f3, #1976d2) !important;
        }
        
        .back-btn {
            background: linear-gradient(135deg, #9c27b0, #7b1fa2) !important;
        }
        
        .derived-highlight {
            background: #ffd700 !important;
        }
        
        .stroke-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
        
        .cheoNeul-text {
            color: #1976d2;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .chung-text {
            color: #7b1fa2;
            font-size: 0.7em;
            font-weight: bold;
        }
        
        .back-header-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .back-header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .back-header-btn {
                left: 10px !important;
                top: 15px !important;
                padding: 8px 12px !important;
                font-size: 14px !important;
            }
            
            .title {
                font-size: 2em !important;
                margin-top: 20px;
            }
            
            .input-section, .result {
                padding: 20px !important;
            }
            
            .char-table {
                font-size: 0.8em;
                table-layout: auto;
            }
            
            .char-cell {
                font-size: 2rem !important;
                height: 80px !important;
                min-width: 60px !important;
            }
            
            .sipseong-number {
                font-size: 1.4em !important;
            }
            
            .cheoNeul-text, .chung-text {
                font-size: 0.6em !important;
            }
            
            .ganzi-info {
                font-size: 1.4em !important;
                padding: 20px !important;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .derived-toggle, .new-analysis-btn {
                width: 100%;
                margin: 0 !important;
                padding: 12px !important;
                font-size: 1em !important;
            }
            
            .char-table td {
                padding: 4px !important;
                font-size: 0.9em;
            }
            
            .stroke-info {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-header-btn" onclick="goBack()">â† ë’¤ë¡œ</button>
            <h1 class="title">ğŸ”® ì„±ëª…í•™ ë¶„ì„</h1>
            <p class="subtitle">ì´ë¦„ê³¼ ìƒë…„ì›”ì¼ë¡œ ìš´ëª…ì„ ì½ë‹¤</p>
        </div>
        
        <div class="input-section" id="inputSection">
            <!-- ì‚¬ìš©ë°©ë²• -->
            <div style="margin-bottom: 40px;">
                <div style="background: white; border-radius: 15px; padding: 25px; text-align: center; color: #333; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 2px solid #e9ecef;">
                    <h4 style="margin-bottom: 15px; font-size: 1.3em; color: #333;">ğŸ“‹ ì‚¬ìš© ë°©ë²•</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="background: #ff6b6b; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: 0 auto 10px; font-weight: bold;">1</div>
                            <p style="font-size: 0.9em; color: #333;">í•œê¸€ ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”</p>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="background: #4ecdc4; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: 0 auto 10px; font-weight: bold;">2</div>
                            <p style="font-size: 0.9em; color: #333;">íƒœì–´ë‚œ ë…„ë„ë¥¼ 4ìë¦¬ë¡œ ì…ë ¥í•˜ì„¸ìš”</p>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="background: #45b7d1; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: 0 auto 10px; font-weight: bold;">3</div>
                            <p style="font-size: 0.9em; color: #333;">ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                        </div>
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; border: 1px solid #dee2e6;">
                            <div style="background: #96ceb4; color: white; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: 0 auto 10px; font-weight: bold;">4</div>
                            <p style="font-size: 0.9em; color: #333;">íŒŒìƒìˆ˜ì™€ ì„¸ìš´ì„ í™•ì¸í•´ë³´ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì´ë¦„ ì…ë ¥ -->
            <div class="input-group">
                <label for="nameInput">ì´ë¦„</label>
                <input type="text" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í™ê¸¸ë™)" maxlength="5">
            </div>
            
            <!-- íƒœì–´ë‚œ ë…„ë„ ì…ë ¥ -->
            <div class="input-group">
                <label for="yearInput">íƒœì–´ë‚œ ë…„ë„</label>
                <input type="number" id="yearInput" placeholder="ë…„ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 1990)" min="1900" max="2025">
            </div>
            
            <!-- ì„±ëª…í•™ ë¶„ì„í•˜ê¸° ë²„íŠ¼ -->
            <button class="analyze-btn" onclick="analyzeName()">ğŸŒŸ ì„±ëª…í•™ ë¶„ì„í•˜ê¸°</button>
            
            <!-- ë¶„ì„ ë‚´ìš© -->
            <div style="margin-top: 50px;">
                <h3 style="text-align: center; color: #333; margin-bottom: 30px; font-size: 1.5em;">ğŸ” ë¶„ì„ ë‚´ìš©</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #f5f5f5; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <div style="font-size: 2em; margin-bottom: 10px;">ğŸ¯</div>
                        <h4 style="color: #333; margin-bottom: 8px;">ì‹­ì„± ë¶„ì„</h4>
                        <p style="color: #666; font-size: 0.9em;">ì´ë¦„ê³¼ ìƒë…„ì›”ì¼ì˜ ì˜¤í–‰ ê´€ê³„ë¥¼<br>í†µí•œ ì‹­ì„± ë¶„ì„</p>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <div style="font-size: 2em; margin-bottom: 10px;">âš¡</div>
                        <h4 style="color: #333; margin-bottom: 8px;">íŒŒìƒìˆ˜ ê³„ì‚°</h4>
                        <p style="color: #666; font-size: 0.9em;">ì‹­ì„± ê°„ì˜ ìƒê·¹ ê´€ê³„ì—ì„œ<br>ë‚˜íƒ€ë‚˜ëŠ” íŒŒìƒìˆ˜ í‘œì‹œ</p>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <div style="font-size: 2em; margin-bottom: 10px;">ğŸŒŸ</div>
                        <h4 style="color: #333; margin-bottom: 8px;">ê°„ì§€ ë¶„ì„</h4>
                        <p style="color: #666; font-size: 0.9em;">íƒœì–´ë‚œ í•´ì˜ ê°„ì§€ì™€<br>ì²œì„ê·€ì¸, ê³µë§, ì¶© ë“± ì‹ ì‚´</p>
                    </div>
                    
                    <div style="background: #f5f5f5; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                        <div style="font-size: 2em; margin-bottom: 10px;">ğŸ“…</div>
                        <h4 style="color: #333; margin-bottom: 8px;">ìŒì–‘ íŒë‹¨</h4>
                        <p style="color: #666; font-size: 0.9em;">ì´ë¦„ íšìˆ˜ë¥¼ í†µí•œ<br>ìŒì–‘ íŒë‹¨ ë° ì˜¤í–‰ ë¶„ë¥˜</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        window.charDataList = [];
        window.birthYear = null;
        
        // ììŒ íšìˆ˜
        const consonantStrokes = {
            'ã„±': 1, 'ã„´': 1, 'ã„·': 2, 'ã„¹': 3, 'ã…': 3, 'ã…‚': 4, 'ã……': 2,
            'ã…‡': 1, 'ã…ˆ': 3, 'ã…Š': 4, 'ã…‹': 2, 'ã…Œ': 3, 'ã…': 4, 'ã…': 3
        };
        
        // ëª¨ìŒ íšìˆ˜
        const vowelStrokes = {
            'ã…': 2, 'ã…‘': 3, 'ã…“': 2, 'ã…•': 3, 'ã…—': 2, 'ã…›': 3, 
            'ã…œ': 2, 'ã… ': 3, 'ã…¡': 1, 'ã…£': 1, 'ã…': 3, 'ã…’': 4, 
            'ã…”': 3, 'ã…–': 4, 'ã…˜': 4, 'ã…™': 5, 'ã…š': 4, 'ã…': 4, 
            'ã…': 5, 'ã…Ÿ': 4, 'ã…¢': 2
        };
        
        // ììŒ â†’ ì˜¤í–‰ ë¶„ë¥˜
        const consonantToElement = {
            'ã„±': 'æœ¨', 'ã…‹': 'æœ¨',
            'ã„´': 'ç«', 'ã„·': 'ç«', 'ã„¹': 'ç«', 'ã…Œ': 'ç«',
            'ã…‡': 'åœŸ', 'ã…': 'åœŸ',
            'ã……': 'é‡‘', 'ã…ˆ': 'é‡‘', 'ã…Š': 'é‡‘',
            'ã…': 'æ°´', 'ã…‚': 'æ°´', 'ã…': 'æ°´'
        };
        
        // ì‹­ì„± ì´ë¦„
        const sipseongNames = [
            'ì •ì¸', 'ë¹„ê²¬', 'ê²ì¬', 'ì‹ì‹ ', 'ìƒê´€', 'í¸ì¬', 'ì •ì¬', 'í¸ê´€', 'ì •ê´€', 'í¸ì¸'
        ];
        
        // ì²œì„ê·€ì¸í‘œ
        const cheonEulGuiIn = {
            'ç”²': ['ä¸‘', 'æœª'], 'ä¹™': ['ç”³', 'å­'], 'ä¸™': ['é…‰', 'äº¥'], 'ä¸': ['äº¥', 'é…‰'],
            'æˆŠ': ['ä¸‘', 'æœª'], 'å·±': ['å­', 'ç”³'], 'åºš': ['ä¸‘', 'æœª'], 'è¾›': ['å¯…', 'åˆ'],
            'å£¬': ['å¯', 'å·³'], 'ç™¸': ['å·³', 'å¯']
        };
        
        // ê·€ë¬¸ê´€ì‚´ ìŒ
        const guimunGwansal = [
            ['å­', 'é…‰'], ['ä¸‘', 'åˆ'], ['å¯…', 'æœª'], 
            ['å¯', 'ç”³'], ['è¾°', 'äº¥'], ['å·³', 'æˆŒ']
        ];
        
        // ì¶©(æ²–) ìŒ
        const chungPairs = [
            ['å¯…', 'ç”³'], ['å¯', 'é…‰'], ['è¾°', 'æˆŒ'], 
            ['å·³', 'äº¥'], ['åˆ', 'å­'], ['æœª', 'ä¸‘']
        ];
        
        // 60ê°‘ì ìˆœì„œ
        const sixtyGapja = [
            'ç”²å­','ä¹™ä¸‘','ä¸™å¯…','ä¸å¯','æˆŠè¾°','å·±å·³','åºšåˆ','è¾›æœª','å£¬ç”³','ç™¸é…‰',
            'ç”²æˆŒ','ä¹™äº¥','ä¸™å­','ä¸ä¸‘','æˆŠå¯…','å·±å¯','åºšè¾°','è¾›å·³','å£¬åˆ','ç™¸æœª',
            'ç”²ç”³','ä¹™é…‰','ä¸™æˆŒ','ä¸äº¥','æˆŠå­','å·±ä¸‘','åºšå¯…','è¾›å¯','å£¬è¾°','ç™¸å·³',
            'ç”²åˆ','ä¹™æœª','ä¸™ç”³','ä¸é…‰','æˆŠæˆŒ','å·±äº¥','åºšå­','è¾›ä¸‘','å£¬å¯…','ç™¸å¯',
            'ç”²è¾°','ä¹™å·³','ä¸™åˆ','ä¸æœª','æˆŠç”³','å·±é…‰','åºšæˆŒ','è¾›äº¥','å£¬å­','ç™¸ä¸‘',
            'ç”²å¯…','ä¹™å¯','ä¸™è¾°','ä¸å·³','æˆŠåˆ','å·±æœª','åºšç”³','è¾›é…‰','å£¬æˆŒ','ç™¸äº¥'
        ];
        
        // í•œê¸€ ë¶„í•´
        function hangulDecompose(char) {
            const charCode = char.charCodeAt(0);
            if (charCode < 0xAC00 || charCode > 0xD7A3) return null;
            
            const index = charCode - 0xAC00;
            const initial = Math.floor(index / 588);
            const medial = Math.floor((index % 588) / 28);
            const final = index % 28;
            
            const initials = ['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            const medials = ['ã…','ã…','ã…‘','ã…’','ã…“','ã…”','ã…•','ã…–','ã…—','ã…˜','ã…™','ã…š','ã…›','ã…œ','ã…','ã…','ã…Ÿ','ã… ','ã…¡','ã…¢','ã…£'];
            const finals = ['','ã„±','ã„²','ã„±ã……','ã„´','ã„´ã…ˆ','ã„´ã…','ã„·','ã„¹','ã„¹ã„±','ã„¹ã…','ã„¹ã…‚','ã„¹ã……','ã„¹ã…Œ','ã„¹ã…','ã„¹ã…','ã…','ã…‚','ã…‚ã……','ã……','ã…†','ã…‡','ã…ˆ','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
            
            return {
                initial: initials[initial],
                medial: medials[medial],
                final: final === 0 ? '' : finals[final]
            };
        }
        
        // ê°„ì§€ ê³„ì‚°
        function getGanJi(year) {
            const ganHanja = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
            const jiHanja = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
            const ganKorean = ['ê°‘', 'ì„', 'ë³‘', 'ì •', 'ë¬´', 'ê¸°', 'ê²½', 'ì‹ ', 'ì„', 'ê³„'];
            const jiKorean = ['ì', 'ì¶•', 'ì¸', 'ë¬˜', 'ì§„', 'ì‚¬', 'ì˜¤', 'ë¯¸', 'ì‹ ', 'ìœ ', 'ìˆ ', 'í•´'];
            
            const baseYear = 1984;
            const yearDiff = year - baseYear;
            
            let ganIndex = yearDiff % 10;
            let jiIndex = yearDiff % 12;
            
            if (ganIndex < 0) ganIndex += 10;
            if (jiIndex < 0) jiIndex += 12;
            
            return {
                ganHanja: ganHanja[ganIndex],
                jiHanja: jiHanja[jiIndex],
                fullKorean: ganKorean[ganIndex] + jiKorean[jiIndex] + 'ë…„'
            };
        }
        
        // ì‹­ì„± ê³„ì‚°
        function calculateSipseong(myElement, myYinYang, targetElement, targetYinYang) {
            const relations = {
                'æœ¨': { generates: 'ç«', destroys: 'åœŸ', generatedBy: 'æ°´', destroyedBy: 'é‡‘' },
                'ç«': { generates: 'åœŸ', destroys: 'é‡‘', generatedBy: 'æœ¨', destroyedBy: 'æ°´' },
                'åœŸ': { generates: 'é‡‘', destroys: 'æ°´', generatedBy: 'ç«', destroyedBy: 'æœ¨' },
                'é‡‘': { generates: 'æ°´', destroys: 'æœ¨', generatedBy: 'åœŸ', destroyedBy: 'ç«' },
                'æ°´': { generates: 'æœ¨', destroys: 'ç«', generatedBy: 'é‡‘', destroyedBy: 'åœŸ' }
            };
            
            if (!relations[targetElement] || !relations[myElement]) {
                return 0;
            }
            
            const sameYinYang = myYinYang === targetYinYang;
            
            if (myElement === targetElement) {
                return sameYinYang ? 1 : 2;
            } else if (relations[targetElement].generates === myElement) {
                return sameYinYang ? 9 : 0;
            } else if (relations[myElement].generates === targetElement) {
                return sameYinYang ? 3 : 4;
            } else if (relations[targetElement].destroys === myElement) {
                return sameYinYang ? 7 : 8;
            } else if (relations[myElement].destroys === targetElement) {
                return sameYinYang ? 5 : 6;
            }
            
            return 0;
        }
        
        // í•œìì—ì„œ ì˜¤í–‰ ì¶”ì¶œ
        function getElementFromHanja(hanja) {
            const hanjaToElement = {
                'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 
                'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘',
                'å£¬': 'æ°´', 'ç™¸': 'æ°´',
                'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨', 
                'è¾°': 'åœŸ', 'å·³': 'ç«', 'åˆ': 'ç«', 'æœª': 'åœŸ',
                'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´'
            };
            return hanjaToElement[hanja] || 'åœŸ';
        }
        
        // í•œì ìŒì–‘ íŒë‹¨
        function getYinYangFromHanja(hanja) {
            const yangHanja = ['ç”²','ä¸™','æˆŠ','åºš','å£¬','å¯…','è¾°','åˆ','ç”³','æˆŒ'];
            return yangHanja.includes(hanja) ? 'yang' : 'eum';
        }
        
        // ê·€ë¬¸ê´€ì‚´ í™•ì¸
        function checkGuimunGwansal(yearJiji, nameJiji) {
            return guimunGwansal.some(pair => 
                (pair[0] === yearJiji && pair[1] === nameJiji) ||
                (pair[1] === yearJiji && pair[0] === nameJiji)
            );
        }
        
        // ê³µë§ í™•ì¸
        function getGongmang(yearGanJi) {
            const index = sixtyGapja.indexOf(yearGanJi);
            if (index === -1) return [];
            
            const groupIndex = Math.floor(index / 10);
            const gongmangGroups = [
                ['æˆŒ', 'äº¥'], ['ç”³', 'é…‰'], ['åˆ', 'æœª'], 
                ['è¾°', 'å·³'], ['å¯…', 'å¯'], ['å­', 'ä¸‘']
            ];
            
            return gongmangGroups[groupIndex] || [];
        }
        
        // ì¶© í™•ì¸
        function checkChung(yearJiji, nameJiji) {
            return chungPairs.some(pair => 
                (pair[0] === yearJiji && pair[1] === nameJiji) ||
                (pair[1] === yearJiji && pair[0] === nameJiji)
            );
        }
        
        // í† ì˜ ì§€ì§€ ë³€í™˜ (ìŒì–‘ê¶Œ ê³ ë ¤)
        function convertToJijiWithSeason(cheongan, yearJiji) {
            const yangGwon = ['å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª'];
            const eumGwon = ['ç”³', 'é…‰', 'æˆŒ', 'äº¥', 'å­', 'ä¸‘'];
            
            const isYangGwon = yangGwon.includes(yearJiji);
            
            const conversion = {
                'ç”²': 'å¯…', 'ä¹™': 'å¯', 'ä¸™': 'å·³', 'ä¸': 'åˆ', 
                'å£¬': 'äº¥', 'ç™¸': 'å­', 'åºš': 'ç”³', 'è¾›': 'é…‰'
            };
            
            if (cheongan === 'æˆŠ') {
                return isYangGwon ? 'è¾°' : 'æˆŒ';
            } else if (cheongan === 'å·±') {
                return isYangGwon ? 'æœª' : 'ä¸‘';
            }
            
            return conversion[cheongan] || '';
        }
        
        // ì‹­ì„± ê·¸ë£¹ íŒë³„
        function getSipseongGroup(sipseong) {
            if ([1, 2].includes(sipseong)) return 'bijup';
            if ([3, 4].includes(sipseong)) return 'siksang';
            if ([5, 6].includes(sipseong)) return 'jaeseong';
            if ([7, 8].includes(sipseong)) return 'gwanseong';
            if ([9, 0].includes(sipseong)) return 'inseong';
            return 'unknown';
        }
        
        // ìƒê·¹ ê´€ê³„ í™•ì¸
        function isGeukRelation(group1, group2) {
            const geukMap = {
                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                'siksang': 'gwanseong', 'gwanseong': 'bijup'
            };
            
            return geukMap[group1] === group2 || geukMap[group2] === group1;
        }
        
        // ê·¹ë‹¹í•˜ëŠ” ê·¸ë£¹ì´ ë„ë§ê°€ëŠ” ëŒ€ìƒ
        function getEscapeTarget(attackedGroup) {
            const escapeMap = {
                'bijup': [5, 6], 'jaeseong': [9, 0], 'inseong': [3, 4],
                'siksang': [7, 8], 'gwanseong': [1, 2]
            };
            return escapeMap[attackedGroup] || [];
        }
        
        // ì„±ëª…í•™ ë¶„ì„ í•¨ìˆ˜
        function analyzeName() {
            const name = document.getElementById('nameInput').value.trim();
            const year = parseInt(document.getElementById('yearInput').value);
            
            if (!name || !year) {
                alert('ì´ë¦„ê³¼ íƒœì–´ë‚œ ë…„ë„ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            document.getElementById('inputSection').classList.add('hidden');
            
            const ganJi = getGanJi(year);
            const ganElement = getElementFromHanja(ganJi.ganHanja);
            const jiElement = getElementFromHanja(ganJi.jiHanja);
            const ganYinYang = getYinYangFromHanja(ganJi.ganHanja);
            const jiYinYang = getYinYangFromHanja(ganJi.jiHanja);
            
            let resultHTML = `
                <div class="result">
                    <div class="result-title">ğŸ”® ${name}ë‹˜ì˜ ì„±ëª…í•™ ë¶„ì„ ê²°ê³¼</div>
                    <div class="ganzi-info">
                        <strong>íƒœì–´ë‚œ í•´:</strong> ${year}ë…„ ${ganJi.fullKorean} (${ganJi.ganHanja}${ganJi.jiHanja})
                    </div>
            `;
            
            const charDataList = [];
            
            for (let i = 0; i < name.length; i++) {
                const char = name[i];
                const decomposed = hangulDecompose(char);
                
                if (!decomposed) continue;
                
                const {initial, medial, final} = decomposed;
                
                let totalStrokes = 0;
                totalStrokes += consonantStrokes[initial] || 0;
                totalStrokes += vowelStrokes[medial] || 0;
                if (final) {
                    totalStrokes += consonantStrokes[final] || 0;
                }
                
                const isYang = totalStrokes % 2 === 1;
                const yinYangType = isYang ? 'yang' : 'eum';
                
                const consonants = [initial];
                if (final && final !== '') {
                    consonants.push(final);
                }
                
                const charData = {
                    char: char,
                    totalStrokes: totalStrokes,
                    isYang: isYang,
                    consonants: consonants,
                    sipseongData: []
                };
                
                consonants.forEach(consonant => {
                    const element = consonantToElement[consonant];
                    if (element) {
                        const cheongan = isYang ? 
                            (element === 'æœ¨' ? 'ç”²' : element === 'ç«' ? 'ä¸™' : element === 'åœŸ' ? 'æˆŠ' : element === 'é‡‘' ? 'åºš' : 'å£¬') :
                            (element === 'æœ¨' ? 'ä¹™' : element === 'ç«' ? 'ä¸' : element === 'åœŸ' ? 'å·±' : element === 'é‡‘' ? 'è¾›' : 'ç™¸');
                        
                        const myElement = element;
                        const myYinYang = yinYangType;
                        
                        const ganSipseong = calculateSipseong(myElement, myYinYang, ganElement, ganYinYang);
                        const jiSipseong = calculateSipseong(myElement, myYinYang, jiElement, jiYinYang);
                        
                        charData.sipseongData.push({
                            consonant: consonant,
                            element: element,
                            cheongan: cheongan,
                            ganSipseong: ganSipseong,
                            jiSipseong: jiSipseong,
                            jiji: convertToJijiWithSeason(cheongan, ganJi.jiHanja)
                        });
                    }
                });
                
                charDataList.push(charData);
                
                let tableHTML = `
                    <div class="char-analysis">
                        <div class="stroke-info">${char}ì: ${totalStrokes}íš (${isYang ? 'ì–‘' : 'ìŒ'})</div>
                        <table class="char-table" data-char="${char}" data-char-index="${i}">
                            <tr>
                                <td colspan="7" class="ganzi-header">${ganJi.ganHanja} ${ganJi.jiHanja}</td>
                            </tr>
                            <tr class="derived-row">
                                <td class="derived-cell derived-left-cell">P</td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell"></td>
                                <td class="derived-cell derived-right-cell">P</td>
                            </tr>
                `;
                
                charData.sipseongData.forEach((sipseongInfo, index) => {
                    const yearGanGuiIn = cheonEulGuiIn[ganJi.ganHanja] || [];
                    const yearJiGuiIn = cheonEulGuiIn[ganJi.jiHanja] || [];
                    
                    const hasLeftCheonEul = yearGanGuiIn.includes(sipseongInfo.jiji);
                    const hasRightCheonEul = yearJiGuiIn.includes(sipseongInfo.jiji);
                    
                    const hasLeftGuimun = checkGuimunGwansal(ganJi.jiHanja, sipseongInfo.jiji);
                    const hasRightGuimun = checkGuimunGwansal(ganJi.jiHanja, sipseongInfo.jiji);
                    
                    const yearGongmang = getGongmang(ganJi.ganHanja + ganJi.jiHanja);
                    const hasLeftGongmang = yearGongmang.includes(sipseongInfo.jiji);
                    const hasRightGongmang = yearGongmang.includes(sipseongInfo.jiji);
                    
                    const hasLeftChung = checkChung(ganJi.jiHanja, sipseongInfo.jiji);
                    const hasRightChung = checkChung(ganJi.jiHanja, sipseongInfo.jiji);
                    
                    let leftSpecialText = '';
                    let rightSpecialText = '';
                    
                    if (hasLeftCheonEul) leftSpecialText += 'ì²œì„';
                    if (hasLeftGuimun) {
                        if (leftSpecialText) leftSpecialText += '<br>';
                        leftSpecialText += 'ê·€ë¬¸';
                    }
                    if (hasLeftGongmang) {
                        if (leftSpecialText) leftSpecialText += '<br>';
                        leftSpecialText += 'ê³µë§';
                    }
                    
                    if (hasRightCheonEul) rightSpecialText += 'ì²œì„';
                    if (hasRightGuimun) {
                        if (rightSpecialText) rightSpecialText += '<br>';
                        rightSpecialText += 'ê·€ë¬¸';
                    }
                    if (hasRightGongmang) {
                        if (rightSpecialText) rightSpecialText += '<br>';
                        rightSpecialText += 'ê³µë§';
                    }
                    
                    let leftChungText = hasLeftChung ? 'ì¶©' : '';
                    let rightChungText = hasRightChung ? 'ì¶©' : '';
                    
                    if (index === 0) {
                        const rowSpan = charData.sipseongData.length;
                        tableHTML += `
                            <tr class="sipseong-row" data-left-sipseong="${sipseongInfo.ganSipseong}" data-right-sipseong="${sipseongInfo.jiSipseong}">
                                <td class="derived-left-cell"></td>
                                <td class="sipseong-number">${sipseongInfo.ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                <td>${sipseongNames[sipseongInfo.ganSipseong]}</td>
                                <td class="char-cell" rowspan="${rowSpan}">${char}</td>
                                <td>${sipseongNames[sipseongInfo.jiSipseong]}</td>
                                <td class="sipseong-number">${sipseongInfo.jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                <td class="derived-right-cell"></td>
                            </tr>
                        `;
                    } else {
                        tableHTML += `
                            <tr class="sipseong-row" data-left-sipseong="${sipseongInfo.ganSipseong}" data-right-sipseong="${sipseongInfo.jiSipseong}">
                                <td class="derived-left-cell"></td>
                                <td class="sipseong-number">${sipseongInfo.ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                <td>${sipseongNames[sipseongInfo.ganSipseong]}</td>
                                <td>${sipseongNames[sipseongInfo.jiSipseong]}</td>
                                <td class="sipseong-number">${sipseongInfo.jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                <td class="derived-right-cell"></td>
                            </tr>
                        `;
                    }
                });
                
                const cheonganList = charData.sipseongData.map(data => data.cheongan);
                tableHTML += `
                    <tr class="cheongan-row">
                        <td colspan="7">${cheonganList.join('')}</td>
                    </tr>
                </table>
                </div>
                `;
                
                resultHTML += tableHTML;
            }
            
            resultHTML += `
                <div class="buttons">
                    <button class="derived-toggle" onclick="toggleDerived()">ğŸ”¢ íŒŒìƒìˆ˜ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>
                    <button class="new-analysis-btn" onclick="newAnalysis()">ğŸ”„ ìƒˆë¡œìš´ ë¶„ì„í•˜ê¸°</button>
                    <button class="new-analysis-btn saeun-btn" onclick="testSaeun()">ğŸ“… ì„¸ìš´ ë³´ê¸°</button>
                </div>
                </div>
            `;
            
            document.getElementById('result').innerHTML = resultHTML;
            
            window.charDataList = charDataList;
            window.birthYear = year;
        }
        
        // í…ŒìŠ¤íŠ¸ìš© ì„¸ìš´ í•¨ìˆ˜
        function testSaeun() {
            if (!window.birthYear) {
                alert('ë¨¼ì € ì„±ëª…í•™ ë¶„ì„ì„ í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const resultDiv = document.querySelector('.result');
            const inputHTML = `
                <div style="background: #fff3e0; padding: 30px; margin: 20px 0; border-radius: 15px; text-align: center; border: 2px solid #ff9800;">
                    <h3 style="color: #e65100; margin-bottom: 20px;">ğŸ“… ì„¸ìš´ ë…„ë„ ì…ë ¥</h3>
                    <input type="number" id="saeunYearInput" placeholder="ì˜ˆ: 2025" style="padding: 15px; font-size: 1.2em; border: 2px solid #ddd; border-radius: 8px; width: 200px; text-align: center;" min="1900" max="2100">
                    <br><br>
                    <button onclick="calculateSaeun()" style="background: #2196f3; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1em; margin-right: 10px; cursor: pointer;">ì„¸ìš´ ê³„ì‚°í•˜ê¸°</button>
                    <button onclick="closeSaeunInput()" style="background: #f44336; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1em; cursor: pointer;">ì·¨ì†Œ</button>
                </div>
            `;
            
            resultDiv.insertAdjacentHTML('beforeend', inputHTML);
            document.getElementById('saeunYearInput').focus();
        }
        
        // ì„¸ìš´ ê³„ì‚° ì‹¤í–‰
        function calculateSaeun() {
            const yearInput = document.getElementById('saeunYearInput');
            const year = yearInput.value;
            
            if (!year || isNaN(year) || year < 1900 || year > 2100) {
                alert('1900~2100 ì‚¬ì´ì˜ ì˜¬ë°”ë¥¸ ë…„ë„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const saeunYear = parseInt(year);
            closeSaeunInput();
            showSaeunReal(saeunYear);
        }
        
        // ì„¸ìš´ ì…ë ¥ì°½ ë‹«ê¸°
        function closeSaeunInput() {
            const inputDiv = document.querySelector('.result > div:last-child');
            if (inputDiv && inputDiv.innerHTML.includes('ì„¸ìš´ ë…„ë„ ì…ë ¥')) {
                inputDiv.remove();
            }
        }
        
        // ì‹¤ì œ ì„¸ìš´ ê³„ì‚° í•¨ìˆ˜
        function showSaeunReal(saeunYear) {
            const saeunGanJi = getGanJi(saeunYear);
            const birthYear = window.birthYear;
            const birthGanJi = getGanJi(birthYear);
            
            createSaeunTable(saeunYear, saeunGanJi, birthYear, birthGanJi);
        }
        
        // ì„¸ìš´ í‘œ ë§Œë“¤ê¸°
        function createSaeunTable(saeunYear, saeunGanJi, birthYear, birthGanJi) {
            try {
                const charDataList = window.charDataList || [];
                if (charDataList.length === 0) {
                    alert('ì´ë¦„ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì„±ëª…í•™ ë¶„ì„ì„ í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const saeunGanElement = getElementFromHanja(saeunGanJi.ganHanja);
                const saeunGanYinYang = getYinYangFromHanja(saeunGanJi.ganHanja);
                const saeunJiElement = getElementFromHanja(saeunGanJi.jiHanja);
                const saeunJiYinYang = getYinYangFromHanja(saeunGanJi.jiHanja);
                
                let saeunHTML = `
                    <div class="char-analysis" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border: 2px solid #2196f3;">
                        <h3 style="text-align: center; color: #1976d2; margin-bottom: 20px; font-size: 3.5em; font-weight: 700;">
                            ğŸ“… ${saeunYear}ë…„ ì„¸ìš´ ë¶„ì„
                        </h3>
                `;
                
                charDataList.forEach((charData, charIndex) => {
                    let saeunTableHTML = `
                        <div style="margin-bottom: 30px;">
                            <div style="text-align: center; margin-bottom: 15px; font-weight: bold; color: #1976d2;">
                                ${charData.char}ì ì„¸ìš´ (${charData.totalStrokes}íš, ${charData.isYang ? 'ì–‘' : 'ìŒ'})
                            </div>
                            <table class="char-table" data-saeun-index="${charIndex}">
                                <tr>
                                    <td colspan="7" class="ganzi-header" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2) !important;">${saeunGanJi.ganHanja} ${saeunGanJi.jiHanja}</td>
                                </tr>
                                <tr class="derived-row">
                                    <td class="derived-cell derived-left-cell">P</td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell"></td>
                                    <td class="derived-cell derived-right-cell">P</td>
                                </tr>
                    `;
                    
                    // ì„¸ìš´ ì‹­ì„±ë“¤ ê³„ì‚°
                    let saeunSipseongs = [];
                    charData.sipseongData.forEach((sipseongInfo, index) => {
                        const myElement = getElementFromHanja(sipseongInfo.cheongan);
                        const myYinYang = charData.isYang ? 'yang' : 'eum';
                        
                        const ganSipseong = calculateSipseong(myElement, myYinYang, saeunGanElement, saeunGanYinYang);
                        const jiSipseong = calculateSipseong(myElement, myYinYang, saeunJiElement, saeunJiYinYang);
                        
                        saeunSipseongs.push({ ganSipseong, jiSipseong, index });
                    });
                    
                    // íŒŒìƒìˆ˜ ê³„ì‚°
                    let derivedData = [];
                    
                    // ì™¼ìª½ ì„¸ë¡œ íŒŒìƒìˆ˜
                    for (let i = 0; i < saeunSipseongs.length - 1; i++) {
                        const current = saeunSipseongs[i].ganSipseong;
                        const next = saeunSipseongs[i + 1].ganSipseong;
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            let attackedGroup = geukMap[currentGroup] === nextGroup ? nextGroup : currentGroup;
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            derivedData.push({ position: 'left', index: i, numbers: escapeTarget.join(',') });
                        }
                    }
                    
                    // ì˜¤ë¥¸ìª½ ì„¸ë¡œ íŒŒìƒìˆ˜
                    for (let i = 0; i < saeunSipseongs.length - 1; i++) {
                        const current = saeunSipseongs[i].jiSipseong;
                        const next = saeunSipseongs[i + 1].jiSipseong;
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            let attackedGroup = geukMap[currentGroup] === nextGroup ? nextGroup : currentGroup;
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            derivedData.push({ position: 'right', index: i, numbers: escapeTarget.join(',') });
                        }
                    }
                    
                    charData.sipseongData.forEach((sipseongInfo, index) => {
                        const myElement = getElementFromHanja(sipseongInfo.cheongan);
                        const myYinYang = charData.isYang ? 'yang' : 'eum';
                        
                        const ganSipseong = calculateSipseong(myElement, myYinYang, saeunGanElement, saeunGanYinYang);
                        const jiSipseong = calculateSipseong(myElement, myYinYang, saeunJiElement, saeunJiYinYang);
                        
                        // ì„¸ìš´ì—ì„œì˜ ì‹ ì‚´ ê³„ì‚°
                        const saeunGanGuiIn = cheonEulGuiIn[saeunGanJi.ganHanja] || [];
                        const saeunJiGuiIn = cheonEulGuiIn[saeunGanJi.jiHanja] || [];
                        
                        const hasLeftCheonEul = saeunGanGuiIn.includes(sipseongInfo.jiji);
                        const hasRightCheonEul = saeunJiGuiIn.includes(sipseongInfo.jiji);
                        
                        const hasLeftGuimun = checkGuimunGwansal(saeunGanJi.jiHanja, sipseongInfo.jiji);
                        const hasRightGuimun = checkGuimunGwansal(saeunGanJi.jiHanja, sipseongInfo.jiji);
                        
                        const saeunGongmang = getGongmang(saeunGanJi.ganHanja + saeunGanJi.jiHanja);
                        const hasLeftGongmang = saeunGongmang.includes(sipseongInfo.jiji);
                        const hasRightGongmang = saeunGongmang.includes(sipseongInfo.jiji);
                        
                        const hasLeftChung = checkChung(saeunGanJi.jiHanja, sipseongInfo.jiji);
                        const hasRightChung = checkChung(saeunGanJi.jiHanja, sipseongInfo.jiji);
                        
                        let leftSpecialText = '';
                        let rightSpecialText = '';
                        
                        if (hasLeftCheonEul) leftSpecialText += 'ì²œì„';
                        if (hasLeftGuimun) {
                            if (leftSpecialText) leftSpecialText += '<br>';
                            leftSpecialText += 'ê·€ë¬¸';
                        }
                        if (hasLeftGongmang) {
                            if (leftSpecialText) leftSpecialText += '<br>';
                            leftSpecialText += 'ê³µë§';
                        }
                        
                        if (hasRightCheonEul) rightSpecialText += 'ì²œì„';
                        if (hasRightGuimun) {
                            if (rightSpecialText) rightSpecialText += '<br>';
                            rightSpecialText += 'ê·€ë¬¸';
                        }
                        if (hasRightGongmang) {
                            if (rightSpecialText) rightSpecialText += '<br>';
                            rightSpecialText += 'ê³µë§';
                        }
                        
                        let leftChungText = hasLeftChung ? 'ì¶©' : '';
                        let rightChungText = hasRightChung ? 'ì¶©' : '';
                        
                        // ì´ í–‰ì˜ íŒŒìƒìˆ˜ ì°¾ê¸°
                        const leftDerived = derivedData.find(d => d.position === 'left' && d.index === index);
                        const rightDerived = derivedData.find(d => d.position === 'right' && d.index === index);
                        
                        if (index === 0) {
                            const rowSpan = charData.sipseongData.length;
                            saeunTableHTML += `
                                <tr class="sipseong-row">
                                    <td class="derived-left-cell"></td>
                                    <td class="sipseong-number">${ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                    <td>${sipseongNames[ganSipseong]}</td>
                                    <td class="char-cell" rowspan="${rowSpan}">${charData.char}</td>
                                    <td>${sipseongNames[jiSipseong]}</td>
                                    <td class="sipseong-number">${jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                    <td class="derived-right-cell"></td>
                                </tr>
                            `;
                        } else {
                            saeunTableHTML += `
                                <tr class="sipseong-row">
                                    <td class="derived-left-cell"></td>
                                    <td class="sipseong-number">${ganSipseong}${leftSpecialText ? '<br><span class="cheoNeul-text">' + leftSpecialText + '</span>' : ''}${leftChungText ? '<br><span class="chung-text">' + leftChungText + '</span>' : ''}</td>
                                    <td>${sipseongNames[ganSipseong]}</td>
                                    <td>${sipseongNames[jiSipseong]}</td>
                                    <td class="sipseong-number">${jiSipseong}${rightSpecialText ? '<br><span class="cheoNeul-text">' + rightSpecialText + '</span>' : ''}${rightChungText ? '<br><span class="chung-text">' + rightChungText + '</span>' : ''}</td>
                                    <td class="derived-right-cell"></td>
                                </tr>
                            `;
                        }
                    });
                    
                    const cheonganList = charData.sipseongData.map(data => data.cheongan);
                    saeunTableHTML += `
                        <tr class="cheongan-row">
                            <td colspan="7" style="background: #f0f0f0; height: 35px; text-align: center; font-weight: bold;">${cheonganList.join('')}</td>
                        </tr>
                    </table>
                    </div>
                    `;
                    
                    saeunHTML += saeunTableHTML;
                });
                
                saeunHTML += `
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="toggleSaeunDerived()" class="derived-toggle" style="margin-right: 15px;">ğŸ”¢ ì„¸ìš´ íŒŒìƒìˆ˜ ë³´ê¸°</button>
                            <button onclick="closeSaeun()" class="new-analysis-btn" style="background: linear-gradient(135deg, #f44336, #d32f2f);">âŒ ì„¸ìš´ ë‹«ê¸°</button>
                        </div>
                    </div>
                `;
                
                const resultDiv = document.querySelector('.result');
                if (resultDiv) {
                    resultDiv.insertAdjacentHTML('beforeend', saeunHTML);
                    document.querySelector('.char-analysis:last-child').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                }
                
            } catch (error) {
                console.error('ì„¸ìš´ ê³„ì‚° ì˜¤ë¥˜:', error);
                alert('ì„¸ìš´ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì„¸ìš´ íŒŒìƒìˆ˜ í† ê¸€ í•¨ìˆ˜
        function toggleSaeunDerived() {
            const button = document.querySelector('.char-analysis:last-child .derived-toggle');
            const saeunContainer = document.querySelector('.char-analysis:last-child');
            const isActive = button.classList.contains('active');
            
            if (!isActive) {
                // ì„¸ìš´ íŒŒìƒìˆ˜ ë³´ì´ê¸° - ì›ë³¸ ì„±ëª…í•™ ë¶„ì„ê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
                const charDataList = window.charDataList || [];
                
                charDataList.forEach((charData, charIndex) => {
                    const table = saeunContainer.querySelector(`[data-saeun-index="${charIndex}"]`);
                    if (!table) return;
                    
                    // ì„¸ìš´ ì‹­ì„±ë“¤ì„ ë‹¤ì‹œ ê³„ì‚°í•´ì„œ íŒŒìƒìˆ˜ ì ìš©
                    const saeunGanJi = getGanJi(parseInt(button.closest('.char-analysis').querySelector('h3').textContent.match(/\d{4}/)[0]));
                    const saeunGanElement = getElementFromHanja(saeunGanJi.ganHanja);
                    const saeunGanYinYang = getYinYangFromHanja(saeunGanJi.ganHanja);
                    const saeunJiElement = getElementFromHanja(saeunGanJi.jiHanja);
                    const saeunJiYinYang = getYinYangFromHanja(saeunGanJi.jiHanja);
                    
                    const leftSipseongs = [];
                    const rightSipseongs = [];
                    
                    charData.sipseongData.forEach((sipseongInfo) => {
                        const myElement = getElementFromHanja(sipseongInfo.cheongan);
                        const myYinYang = charData.isYang ? 'yang' : 'eum';
                        
                        const ganSipseong = calculateSipseong(myElement, myYinYang, saeunGanElement, saeunGanYinYang);
                        const jiSipseong = calculateSipseong(myElement, myYinYang, saeunJiElement, saeunJiYinYang);
                        
                        leftSipseongs.push(ganSipseong);
                        rightSipseongs.push(jiSipseong);
                    });
                    
                    for (let i = 0; i < leftSipseongs.length - 1; i++) {
                        const current = leftSipseongs[i];
                        const next = leftSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup;
                            } else {
                                attackedGroup = currentGroup;
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const leftCell = rows[i].querySelector('.derived-left-cell');
                                if (leftCell) {
                                    leftCell.textContent = derivedText;
                                    leftCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                    
                    for (let i = 0; i < rightSipseongs.length - 1; i++) {
                        const current = rightSipseongs[i];
                        const next = rightSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup;
                            } else {
                                attackedGroup = currentGroup;
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const rightCell = rows[i].querySelector('.derived-right-cell');
                                if (rightCell) {
                                    rightCell.textContent = derivedText;
                                    rightCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                });
                
                button.textContent = 'ğŸ“ ì„¸ìš´ íŒŒìƒìˆ˜ ìˆ¨ê¸°ê¸°';
                button.classList.add('active');
            } else {
                // ì„¸ìš´ íŒŒìƒìˆ˜ ìˆ¨ê¸°ê¸°
                const derivedCells = saeunContainer.querySelectorAll('.derived-highlight');
                derivedCells.forEach(cell => {
                    cell.textContent = 'P';
                    cell.classList.remove('derived-highlight');
                });
                
                button.textContent = 'ğŸ”¢ ì„¸ìš´ íŒŒìƒìˆ˜ ë³´ê¸°';
                button.classList.remove('active');
            }
        }
        
        // ì„¸ìš´ ë‹«ê¸° í•¨ìˆ˜
        function closeSaeun() {
            const saeunResults = document.querySelectorAll('.char-analysis');
            const lastSaeun = saeunResults[saeunResults.length - 1];
            
            if (lastSaeun && lastSaeun.innerHTML.includes('ì„¸ìš´')) {
                lastSaeun.remove();
            }
        }
        
        // íŒŒìƒìˆ˜ í† ê¸€ í•¨ìˆ˜
        function toggleDerived() {
            const button = document.querySelector('.derived-toggle');
            const isActive = button.classList.contains('active');
            
            if (!isActive) {
                const charDataList = window.charDataList || [];
                
                charDataList.forEach((charData, charIndex) => {
                    const table = document.querySelector(`[data-char-index="${charIndex}"]`);
                    if (!table) return;
                    
                    const leftSipseongs = charData.sipseongData.map(data => data.ganSipseong);
                    const rightSipseongs = charData.sipseongData.map(data => data.jiSipseong);
                    
                    for (let i = 0; i < leftSipseongs.length - 1; i++) {
                        const current = leftSipseongs[i];
                        const next = leftSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup;
                            } else {
                                attackedGroup = currentGroup;
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const leftCell = rows[i].querySelector('.derived-left-cell');
                                if (leftCell) {
                                    leftCell.textContent = derivedText;
                                    leftCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                    
                    for (let i = 0; i < rightSipseongs.length - 1; i++) {
                        const current = rightSipseongs[i];
                        const next = rightSipseongs[i + 1];
                        
                        const currentGroup = getSipseongGroup(current);
                        const nextGroup = getSipseongGroup(next);
                        
                        if (isGeukRelation(currentGroup, nextGroup)) {
                            const geukMap = {
                                'bijup': 'jaeseong', 'jaeseong': 'inseong', 'inseong': 'siksang',
                                'siksang': 'gwanseong', 'gwanseong': 'bijup'
                            };
                            
                            let attackedGroup;
                            if (geukMap[currentGroup] === nextGroup) {
                                attackedGroup = nextGroup;
                            } else {
                                attackedGroup = currentGroup;
                            }
                            
                            const escapeTarget = getEscapeTarget(attackedGroup);
                            const derivedText = escapeTarget.join(',');
                            
                            const rows = table.querySelectorAll('.sipseong-row');
                            if (rows[i]) {
                                const rightCell = rows[i].querySelector('.derived-right-cell');
                                if (rightCell) {
                                    rightCell.textContent = derivedText;
                                    rightCell.classList.add('derived-highlight');
                                }
                            }
                        }
                    }
                });
                
                button.textContent = 'ğŸ“ íŒŒìƒìˆ˜ ìˆ¨ê¸°ê¸°';
                button.classList.add('active');
            } else {
                const derivedCells = document.querySelectorAll('.derived-highlight');
                derivedCells.forEach(cell => {
                    cell.textContent = 'P';
                    cell.classList.remove('derived-highlight');
                });
                
                button.textContent = 'ğŸ”¢ íŒŒìƒìˆ˜ ë³´ê¸°/ìˆ¨ê¸°ê¸°';
                button.classList.remove('active');
            }
        }
        
        // ìƒˆë¡œìš´ ë¶„ì„ í•¨ìˆ˜
        function newAnalysis() {
            document.getElementById('inputSection').classList.remove('hidden');
            document.getElementById('result').innerHTML = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('yearInput').value = '';
            document.getElementById('nameInput').focus();
            
            window.charDataList = [];
            window.birthYear = null;
        }
        
        // ë’¤ë¡œ ê°€ê¸° í•¨ìˆ˜
        window.goBack = function() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                // ë§Œì•½ íˆìŠ¤í† ë¦¬ê°€ ì—†ë‹¤ë©´ ìƒìœ„ í˜ì´ì§€ë¡œ ì´ë™ (í•„ìš”ì— ë”°ë¼ ìˆ˜ì •)
                window.location.href = '../index.html';
            }
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('nameInput');
            const yearInput = document.getElementById('yearInput');
            
            if (nameInput) {
                nameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        yearInput.focus();
                    }
                });
            }
            
            if (yearInput) {
                yearInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        analyzeName();
                    }
                });
            }
        });
    </script>
</body>
</html>
